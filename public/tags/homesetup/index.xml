<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Yosua Ian Sebastian's blog</title><link>https://darcien.dev/tags/homesetup/</link><description>Recent posts in my blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 08 Sep 2023 20:46:41 +0700</lastBuildDate><atom:link href="https://darcien.dev/tags/homesetup/index.xml" rel="self" type="application/rss+xml"/><item><title>Monitoring air quality with AirGradient and Home Assistant</title><link>https://darcien.dev/p/airgradient/</link><pubDate>Fri, 08 Sep 2023 20:46:41 +0700</pubDate><guid>https://darcien.dev/p/airgradient/</guid><description>My journey for better air quality.</description><content:encoded><![CDATA[<blockquote>
<p>üîñ Assumed post audience: someone who wants to know what it takes to setup
self hosted air quality monitor.</p>
</blockquote>
<p>Recently I pulled the trigger and bought air quality monitor from <a href="https://www.airgradient.com/">AirGradient</a>.
Definitely not because my city has plummeted from bad to worst<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>This post will contain everything I did to set up AirGradient, all the way
to storing and viewing historical data locally.</p>
<h2 id="what-partscomponentstools-are-used">What parts/components/tools are used?</h2>
<h3 id="for-air-monitoring">For air monitoring</h3>
<ul>
<li><a href="https://www.airgradient.com/indoor/">AirGradient DIY Pro</a>, I bought 2 units, pre-soldered kit.
My kit includes:
<ul>
<li>Pro PCB version 4.2</li>
<li><a href="https://www.wemos.cc/en/latest/d1/d1_mini.html">ESP8266 WeMos D1 mini v4 microcontroller</a></li>
<li><a href="https://senseair.com/products/size-counts/s8-residential/">Senseair S8 CO2 sensor</a></li>
<li><a href="https://www.plantower.com/en/products_33/74.html">Plantower PMS5003 PM sensor</a></li>
<li><a href="https://www.sensirion.com/products/catalog/SGP41/">Sensirion SGP41 VOC and NOx sensor</a></li>
<li><a href="https://sensirion.com/products/catalog/SHT40">Sensirion SHT40 temperature and humidity sensor</a></li>
<li><a href="https://www.smart-prototyping.com/1_3-inch-OLED-Display-SH1106-SPI-I2C-128-64">SH1106 128x64 1.3&quot; OLED display</a></li>
<li>USB-C 2m cable</li>
<li>plastic enclosure, screws, and (small) screwdriver</li>
</ul>
</li>
<li>Power supply, 5V 3A. This <a href="https://web.archive.org/web/20230908145102/https://forum.airgradient.com/t/pro-kit-power-supply-requirements/374/3#:~:text=For%20the%20D1%20v4%20we%20recommend%205v%20and%20at%20least%202.4A.">forum post</a> mention they recommend 5V and at least 2.4A for WeMos D1 used in the pro kit. I could only find made-in-China power supplies here, it&rsquo;s better than nothing.</li>
<li>USB cable, 3m, USB-A to USB-C with right angle so it can fit behind the air monitor. The supplied 2m cable is not enough for me.</li>
<li><a href="https://www.3m.com/3M/en_US/p/c/home/storage-organization/clips-hooks-adhesive-strips/">3M adhesive hooks</a> and random knitting threads. Using plastic hooks + threads so I don&rsquo;t have to put a hole in the wall to hang the air monitor.</li>
</ul>
<h3 id="for-storing-and-viewing-sensor-data">For storing and viewing sensor data</h3>
<blockquote>
<p>TL;DR I&rsquo;m using Home Assistant container on old MacBook for local server.</p>
</blockquote>
<p>AirGradient has their own home server to host the data sent from the sensor.
I got free 2 year subscription for their server from buying their pro kit.</p>
<p>That means:</p>
<ul>
<li>I need 24/7 internet connection to send the data,</li>
<li>and sending all sensor data to uncontrolled server üôÅ.</li>
</ul>
<p>I don&rsquo;t really like that idea, so I will need my own local server to handle the sensor data.
And reflash the AirGradient microcontroller to send the data to my server instead.</p>
<p><a href="https://forum.airgradient.com/t/airgradient-integrations/703">Searching</a> <a href="https://forum.airgradient.com/t/airgradient-esphome-setup-with-home-assistant/40/2">the</a> <a href="https://forum.airgradient.com/t/sharing-my-experiences/152">internet</a> leads me to <a href="https://www.home-assistant.io/">Home Assistant (HA)</a> + <a href="https://esphome.io/">ESPHome</a> setup.</p>
<p>My options for hosting HA are:</p>
<ol>
<li>reuse Raspberry Pi 2 model B that already runs <a href="../my-first-pi-hole.md">Pi-hole</a>,</li>
<li>use old 15&quot; MacBook from 2015,</li>
<li>use cheapo 14&quot; Lenovo laptop from 2015 (it runs Arch btw),</li>
<li>reuse cloud VM (small droplet in SG region that runs NixOS),</li>
<li>buy ready-to-use <a href="https://www.home-assistant.io/yellow/">Home Assistant server</a>,</li>
<li>buy new Raspberry Pi 4</li>
</ol>
<p>I went through the possible <a href="https://www.home-assistant.io/installation/">HA installation methods</a> to cross-check
which host should I use for HA.</p>
<p>Possible HA installation methods are:</p>
<ul>
<li>Supervised: this requires strict dependencies setup and maintaining them, no go.</li>
<li>OS: this requires wiping the host OS or running VM inside the host, which requires non-trivial overhead for CPU consumption etc. Keen to avoid this.</li>
<li>Core: oh it&rsquo;s Python, sorry but I do not want to manage Python installation, no go.</li>
<li>Container: this require a container environment and running a built HA image.</li>
</ul>
<p>Container installation is the most sane setup for me, so I&rsquo;m going with it.
(Later on I realized HA container cannot use HA add-ons.
That means I cannot use <a href="https://esphome.io/guides/getting_started_hassio">ESPHome HA add-ons</a> to make things easier.
But that is fine, I could live without the add-ons.)</p>
<p>Going back to my hosting choices and by the process of elimination:</p>
<ul>
<li>Raspberry Pi 2 probably won&rsquo;t be strong enough, HA recommends Pi 3 or 4. So, no go.
(I saw <a href="https://community.home-assistant.io/t/what-is-needed-to-set-up-home-assistant-on-a-raspberry-pi-2-model-b/373544/15">some people</a> tried running HA on Pi 2B, it&rsquo;s kinda hit and miss.)</li>
<li>Cloud VM probably will work, but requires internet connection. Keeping this as last resort.</li>
<li>HA Yellow, I checked the price from the <a href="https://www.seeedstudio.com/Home-Assistant-Yellow-Kit-with-selectable-CM4-p-5680.html">Chinese supplier</a>, it&rsquo;s going to cost 179 USD or more, not including shipping and tax.
No thanks, that&rsquo;s too expensive for me.</li>
<li>New Raspberry Pi 4: The official supplier is either gone or out of stock here.
And there&rsquo;s only scalper with crazy price tag in local marketplace. No thanks.</li>
<li>Old laptops, these are my best bets for now.</li>
</ul>
<p>At the end, I picked the MacBook over Lenovo since it has better CPU.
It runs macOS 12 and the UI is a bit laggy, but it should be good enough
since I&rsquo;m only accessing it via SSH anyway.</p>
<h3 id="for-flashing-the-microcontroller">For flashing the microcontroller</h3>
<p>I need to reflash the D1 mini to make it send data to my server.
I have no idea how to do it though, reading ESPHome website feels overwhelming at first.
After furiously reading the docs, FAQ, and a mug of coffee, I think I get it.</p>
<p>With ESPHome, you:</p>
<ol>
<li>write declarative config (in YAML) for the micrcontroller firmware instead of writing the code directly.</li>
<li>use <a href="https://esphome.io/guides/getting_started_command_line">ESPHome CLI</a> to compile the YAML config into a runnable firmware and upload it to the microcontroller.</li>
</ol>
<p>I will be using Docker on macOS to run ESPHome and according to <a href="https://esphome.io/guides/getting_started_command_line.html#:~:text=You%20will%20not%20be%20able%20to%20flash%20ESP%20devices%20through%20USB%20on%20Mac%2C%20all%20other%20features%20will%20work.%20Flashing%20with%20web%20dashboard%20is%20still%20possible.">this</a>,
I won&rsquo;t be able to flash via USB cable.
So I will need to use <a href="https://web.esphome.io/">ESPHome&rsquo;s web flasher</a>.</p>
<h2 id="what-work-are-done-to-start-seeing-numbers-in-dashboard">What work are done to start seeing numbers in dashboard?</h2>
<h3 id="assembling-the-airgradient-kit">Assembling the AirGradient kit</h3>
<p>AirGradient has the full assembly instruction in <a href="https://www.airgradient.com/open-airgradient/instructions/">their website</a>.
Mine is pretty straightforward since I bought the pre-soldered kit which involves
sticking sensor to the correct places.</p>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-unassembled.jpg"
      
      alt="Pre-soldered AirGradient kit that comes with the display and PM sensor already attached."><figcaption>
        
        
        
        <p>Pre-soldered AirGradient kit that comes with the display and PM sensor already attached.</p>
      </figcaption>
  
  </figure><script defer src="https://cdn.jsdelivr.net/npm/lightense-images@1.0.17/dist/lightense.min.js" integrity="sha256-0L7PA+rlAMaq+Gkzls+i1cUvY9i7D+XF/Yl3BhYKABo=" crossorigin="anonymous"></script>
  <script defer type="text/javascript">
    window.addEventListener("load", function() {
      Lightense('img:not(.no-lightense, [aria-label="logo"])', {
        
        
        
        background: 'rgb(155, 156, 157 / 60%)',
      });
    }, false);
  </script>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-assembled.jpg"
      
      alt="Fully assembled kit, with everything sticked in."><figcaption>
        
        
        
        <p>Fully assembled kit, with everything sticked in.</p>
      </figcaption>
  
  </figure>
<h3 id="sanity-checking-the-kit">Sanity checking the kit</h3>
<p>Power on the kit by connecting to power supply.
Make sure everything is looks good, sensors and display are working.
Better do this before screwing the enclosure tightly.</p>
<p>I don&rsquo;t have other sensor for baseline of the installed sensors though.
So I can&rsquo;t sense check the sensor values.</p>
<h3 id="flashing-the-microcontroller">Flashing the microcontroller</h3>
<ol>
<li>Connect the microcontroller directly to a computer with USB cable.
<strong>Connecting the cable to the PCB will not work!</strong></li>
<li>Open up <a href="https://web.esphome.io/">web flasher</a>.</li>
<li>In the flasher, press connect and pick the microcontroller and connect.
On mine, it says &ldquo;USB Serial (cu.usbserial-1120)&rdquo;.
Yours might be different.</li>
<li>Press &ldquo;PREPARE FOR FIRST USE&rdquo;.
Read the explanation first and install after understanding it.</li>
<li>Wait for it to finish installing.</li>
<li>After done installing, continue setting up Wi-Fi for the device in the flasher.
This will allow us to flash over the network.</li>
<li>If everything works fine, you should be able to access the web server hosted
in the microcontoller by accessing the device IP directly.</li>
</ol>
<p>At this point we can start writing ESPHome config be flashed over the network.
I would expect myself taking months to finish writing the config.
Thankfully a nice person has shared their config in the internet, like <a href="https://github.com/ajfriesen/ESPHome-AirGradient">this one</a>.
I end up using this config from <a href="https://github.com/ajfriesen/ESPHome-AirGradient/pull/17">@ex-nerd&rsquo;s PR</a>.
Specifically <a href="https://github.com/ajfriesen/ESPHome-AirGradient/blob/e21604d3455b6fc5429789a8046ff045d4c2a8f9/air-gradient-pro-diy.yaml">this file</a> that&rsquo;s intended for AirGradient Pro version 4.2.</p>
<p>Steps I did for compiling the firmware:</p>
<ol>
<li>Copy the AirGradient config YAML and <code>secrets.yaml</code>,
save them in a new directory somewhere in the computer.</li>
<li>Modify the config as needed, the instruction comments in there is pretty self explanatory.
While editing the YAML, the editor IDE might complain about &ldquo;Unresolved tag: !secret&rdquo;.
It&rsquo;s fine to ignore those warnings.
Those are <a href="https://www.home-assistant.io/docs/configuration/splitting_configuration/">HA config specifics</a> that is <a href="https://esphome.io/guides/faq#:~:text=ESPHome%20supports%20(most%20of)%20Home%20Assistant%E2%80%99s%20YAML%20configuration%20directives%20like%20!include%20and%20!secret.%20So%20you%20can%20store%20all%20your%20secret%20WiFi%20passwords%20and%20so%20on%20in%20a%20file%20called%20secrets.yaml%20within%20the%20directory%20where%20the%20configuration%20file%20is.">also supported by ESPHome</a>.</li>
<li>Fill in the variables in the <code>secrets.yaml</code>.
For the <code>home_assistant_encryption_key</code>, it needs to be base64 string.
The <a href="https://esphome.io/components/api.html">docs page</a> from ESPHome has a generator for it.
<blockquote>
<p>‚úÖ Make sure to backup <code>secrets.yaml</code>, otherwise you will need to reflash
if you lose access.</p>
</blockquote>
</li>
<li>Run <a href="https://esphome.io/guides/getting_started_command_line">ESPHome CLI</a> to compile and upload the firmware to the microcontroller.
I&rsquo;m using Docker to run it, so mine looks like this:
<code>docker run --rm -v &quot;${PWD}&quot;:/config -it ghcr.io/esphome/esphome run air-gradient-pro-diy.yaml</code>.</li>
</ol>
<p>In my case, the upload step failed because <code>esphome</code> unable to find my device.
Error log:</p>
<pre tabindex="0"><code class="language-log" data-lang="log">...
Linking .pioenvs/airgradient-pro-0/firmware.elf
RAM:   [=====     ]  49.3% (used 40392 bytes from 81920 bytes)
Flash: [======    ]  64.7% (used 675549 bytes from 1044464 bytes)
Building .pioenvs/airgradient-pro-0/firmware.bin
esp8266_copy_factory_bin([&#34;.pioenvs/airgradient-pro-0/firmware.bin&#34;], [&#34;.pioenvs/airgradient-pro-0/firmware.elf&#34;])
================================================================================= [SUCCESS] Took 536.00 seconds =================================================================================
INFO Successfully compiled program.
INFO Resolving IP address of airgradient-pro-0.local
ERROR Error resolving IP address of airgradient-pro-0.local. Is it connected to WiFi?
ERROR (If this error persists, please set a static IP address: https://esphome.io/components/wifi.html#manual-ips)
ERROR Error resolving IP address: Error resolving address with mDNS: Did not respond. Maybe the device is offline., [Errno -3] Temporary failure in name resolution
</code></pre><p>So I had to <a href="https://esphome.io/components/wifi.html#:~:text=manual_ip%20(Optional)%3A%20Manually%20configure%20the%20static%20IP%20of%20the%20node.">setup static IP</a> in the config
and rerun the docker command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">wifi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">manual_ip</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Set this to the IP of the ESP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">static_ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;192.168.100.152&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Set this to the IP address of the router. Often ends with .1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;192.168.100.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The subnet of the network. 255.255.255.0 works for most home networks.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;255.255.255.0&#34;</span><span class="w">
</span></span></span></code></pre></div><p>After rerunning the compile command and a successful uploads,
the CLI will start streaming the logs from the device nonstop.
Success logs:</p>
<pre tabindex="0"><code>...
INFO Successfully compiled program.
INFO Connecting to 192.168.100.152
INFO Uploading .esphome/build/airgradient-pro-1/.pioenvs/airgradient-pro-1/firmware.bin (680288 bytes)
INFO Compressed to 475364 bytes
Uploading: [============================================================] 100% Done...

INFO Waiting for result...
INFO OTA successful
INFO Successfully uploaded program.
INFO Starting log output from 192.168.100.152 using esphome API
INFO Successfully connected to 192.168.100.152
[19:48:18][I][app:102]: ESPHome version 2023.8.2 compiled on Sep  8 2023, 19:46:22
...
</code></pre><p>Can terminate the CLI safely after upload succeeds and it start streaming the logs.</p>
<p>The display should also lit up and start showing the pages specified in the config YAML.
Some of sensor numbers might show up as <code>N/A</code> for a while.
I haven&rsquo;t debugged this, but after leaving it powered on for few mins,
<code>N/A</code> got replaced with numbers.
So the sensors might be just starting and simply haven&rsquo;t picked up and sent any data yet.</p>
<p>Now we have the sensors ready to send data,
it&rsquo;s time to setup the receiving part!</p>
<h3 id="setting-up-home-assistant-container">Setting up Home Assistant container</h3>
<p><a href="https://www.home-assistant.io/installation/macos">MacOS HA installation docs</a> actually does not have container installation.
Luckily prior to this, I already found <a href="https://blog.illixion.com/2023/04/colima-home-assistant/">this post from Ixion</a> about setting up Home Assistant on macOS.
I accidentally found that post when trying to find a way to run HA VM image using <a href="https://github.com/lima-vm/lima">Lima</a>,
with the <code>lima</code> keyword accidentally matching on the <a href="https://github.com/abiosoft/colima"><code>colima</code></a> used in the post.</p>
<p>What I did to set up HA is exactly as described in Ixion&rsquo;s post, summarized as:</p>
<blockquote>
<ol>
<li>Install Colima and Docker on macOS (using brew)</li>
<li>Start Colima</li>
<li>Configure Colima to use the host network</li>
<li>Install Home Assistant on Docker</li>
<li>Set up Home Assistant</li>
</ol>
<p><a href="https://blog.illixion.com/2023/04/colima-home-assistant/">https://blog.illixion.com/2023/04/colima-home-assistant/</a></p>
</blockquote>
<p>With some exceptions:</p>
<ul>
<li>When configuring Lima to use <code>socket_vmnet</code>, my path for <code>socket_vmnet</code> is different.
I had to a bit of manual <code>cd</code> and <code>ls</code> ritual, and found mine on <code>/usr/local/opt/socket_vmnet/bin/socket_vmnet</code>
instead of <code>/opt/homebrew/bin/socket_vmnet</code>.
I just learned brew has subcommand for finding the path, <code>brew info &lt;formula&gt;</code>,
e.g. <code>brew info socket_vmnet</code> and it will spit out the installation path.</li>
<li>When opening the network settings in HA, mine is blank.
Turns out I need to turn on &ldquo;Advanced Mode&rdquo; in my HA profile.
After that, I can open the network settings and pick <code>lima0</code> network adapter.
Before realizing that, I thought the network settings is not accessible
remotely. I tried accessing from localhost by port forwarding
the dashboard, it didn&rsquo;t help at all.</li>
</ul>
<h3 id="connecting-airgradient-with-home-assistant">Connecting AirGradient with Home Assistant</h3>
<p>According to this <a href="https://www.home-assistant.io/integrations/esphome/">HA docs</a>, HA should be able to automatically
discover a running ESPHome device in the same network.
I have not tried it.
Instead I tried manually adding the ESPHome device or in this case the AirGradient
to HA.</p>
<p>From the HA dashboard, do:</p>
<ol>
<li>Open &ldquo;Settings &gt; Devices &amp; Services&rdquo;,</li>
<li>In &ldquo;Integrations&rdquo; tab, press &ldquo;ADD INTEGRATION&rdquo; in bottom right,</li>
<li>Search and click &ldquo;ESPHome&rdquo; integration,</li>
<li>Put the AirGradient IP in the host field, keep the default <code>6053</code> port, and submit.</li>
<li>If HA can find and connect to AirGradient, it will ask for encryption key.
Paste in the <code>home_assistant_encryption_key</code> configured in <code>secrets.yaml</code>
that&rsquo;s used for flashing the AirGradient.</li>
</ol>
<p>That&rsquo;s all! I can see my AirGradient sensors in HA dashboard.</p>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/ha-dashboard.png"
      
      alt="My HA dashboard after connecting one AirGradient kit."><figcaption>
        
        
        
        <p>My HA dashboard after connecting one AirGradient kit.</p>
      </figcaption>
  
  </figure>
<h2 id="why-im-getting-cant-connect-to-esp-when-connecting-airgradient-to-ha">Why I&rsquo;m getting <code>Can't connect to ESP.</code> when connecting AirGradient to HA?</h2>
<p>Make sure AirGradient is discoverable from HA.</p>
<p>In my case, I was accessing HA dashboard via <a href="https://tailscale.com/kb/1081/magicdns/">Tailscale Magic DNS</a>.
So my dashboard URL looks like: <code>http://unicorn:8123</code>.
And when adding AirGradient, I keep getting <code>Can't connect to ESP.</code> error
even with the correct IP.
After using SSH tunnel to expose the dashboard as: <code>http://localhost:8123</code>,
adding AirGradient worked!</p>
<p>The tunnel command looked something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -L 8123:localhost:8123 -N -T darcien@unicorn
</span></span></code></pre></div><h2 id="my-ha-container-does-not-expose-any-address-in-colima-list">My HA container does not expose any address in <code>colima list</code>!</h2>
<p>Try doing <code>colima restart</code>, and restart the HA container.
Also check the container log for more clue.</p>
<h2 id="restarting-ha-container-with-colima-restart-failed">Restarting HA container with <code>colima restart</code> failed!</h2>
<p>In my case, <code>colima</code> gives a nice hint:</p>
<pre tabindex="0"><code class="language-log" data-lang="log">‚ùØ colima restart
INFO[0000] stopping colima
INFO[0000] not running                                   context=vm
INFO[0000] done
INFO[0003] starting colima
INFO[0003] runtime: docker
INFO[0003] preparing network ...                         context=vm
INFO[0003] starting ...                                  context=vm
&gt; Using the existing instance &#34;colima&#34;
&gt; can&#39;t read &#34;/private/etc/sudoers.d/lima&#34;: failed to run [sudo --user daemon --group everyone --non-interactive true]: exit status 1 (Hint: run `limactl sudoers &gt;etc_sudoers.d_lima &amp;&amp; sudo install -o root etc_sudoers.d_lima &#34;/private/etc/sudoers.d/lima&#34;`))
FATA[0003] error starting vm: error at &#39;starting&#39;: exit status 1
</code></pre><p>It was a permission issue, and running the command specified in the hint fixed it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">limactl sudoers &gt;etc_sudoers.d_lima <span class="o">&amp;&amp;</span> sudo install -o root etc_sudoers.d_lima <span class="s2">&#34;/private/etc/sudoers.d/lima&#34;</span>
</span></span></code></pre></div><h2 id="how-much-does-it-cost-total">How much does it cost total?</h2>
<table>
<thead>
<tr>
<th>Parts</th>
<th style="text-align:right">Price (IDR)</th>
</tr>
</thead>
<tbody>
<tr>
<td>AirGradient Pro DIY (pre-soldered) x 2</td>
<td style="text-align:right">4.544.100</td>
</tr>
<tr>
<td>AirGradient import tax</td>
<td style="text-align:right">294.400</td>
</tr>
<tr>
<td>Power supply 5V 3A x 2</td>
<td style="text-align:right">271.700</td>
</tr>
<tr>
<td>USB-C 3m cable</td>
<td style="text-align:right">93.500</td>
</tr>
<tr>
<td>3M plastic hook x2</td>
<td style="text-align:right">29.640</td>
</tr>
<tr>
<td>Old MacBook</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td>&mdash;</td>
<td style="text-align:right">&mdash;</td>
</tr>
<tr>
<td>Total</td>
<td style="text-align:right">5.233.340</td>
</tr>
</tbody>
</table>
<p>Using 1 USD = 14850 IDR conversion for AirGradient price calculation.</p>
<p>It&rsquo;s a bit expensive for your average Indonesian, but still pretty good price
when compared to commercial air monitor sold here, like this <a href="https://aria.tech/airtest">AirTest from Aria Indonesia</a>.
The AirTest only have PM2.5 sensor, no idea what specific sensor is installed in it.
It is sold at 1.990.000 IDR and have 30 days pre-order<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>,
now that&rsquo;s expensive for a single sensor with closed design.</p>
<h2 id="how-much-electricity-does-this-setup-use">How much electricity does this setup use?</h2>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/macbook-power-usage_hu17267041814112188327.jpg"
      
      alt="A power meter showing 0.945 KWh after 6 days 15 hours 10 minutes for the server (from empty battery)."><figcaption>
        
        
        
        <p>A power meter showing 0.945 KWh after 6 days 15 hours 10 minutes for the server (from empty battery).</p>
      </figcaption>
  
  </figure>
<p>0.945 KWh = 6 days 15 hours 10 minutes</p>
<p>0.945 KWh = 9550 minutes</p>
<p>0.006 KWh = 60 minutes</p>
<p>That&rsquo;s 0.006 KWh per hour, or 4.32 KWh per month.
So I&rsquo;m paying around 6.241 IDR per month using 1.444,7 IDR per KWh rate.</p>
<p>I&rsquo;m excluding the electricity usage from the sensors because they&rsquo;re too low.
Leaving the metered sensors a week gave me 0 KWh on the power meter.</p>
<h2 id="what-is-the-gfonts-in-the-esphome-config">What is the <code>gfonts://</code> in the ESPHome config?</h2>
<p>It&rsquo;s <a href="https://esphome.io/components/display/index.html#:~:text=You%20can%20use%20the%20gfonts%3A//%20short%20form%20to%20use%20Google%20Fonts">a special ESPHome syntax</a> for using Google Fonts in the display.</p>
<h2 id="how-long-until-the-sensors-needs-to-be-replaced">How long until the sensors needs to be replaced?</h2>
<p>I&rsquo;m not too sure yet.
I&rsquo;m seeing some discussion about this in AirGradient forum,
and AirGradient said they still have PMS5003 sensor working even after 4 years<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.
I sure hope Jakarta&rsquo;s air is not polluted enough to the point I need to
replace PM sensors often.
At that point, sensor life expectancy is the least of my worries.</p>
<h2 id="back-up-plans-for-ha-container">Back up plans for HA container?</h2>
<p>As I just finished with setting up, I have no concrete plans yet.
I looked a bit into the forum and found <a href="https://community.home-assistant.io/t/what-backup-strategy-when-running-home-assistant-in-docker/262539/7">this thread</a>
which has various approaches.
Standing up an automatic backup most likely won&rsquo;t be a 5 minutes job,
so I will need to revisit this later.</p>
<h2 id="how-accurate-is-the-pm-sensors-used-ie-pms5003">How accurate is the PM sensors used? i.e. PMS5003</h2>
<p>I learnt from <a href="https://news.ycombinator.com/item?id=36501314">this post</a> that PMS5003 is using approximation for
PM2.5 and PM10, and is only accurate for PM1.
Well fortunately, <a href="https://blog.quant-aq.com/can-your-plantower-pms5003-based-air-quality-sensor-measure-pm10/">the in-depth explanation</a> proves PMS5003
is good enough for urban environment that doesn&rsquo;t change too much like my
bedroom and livingroom!</p>
<h2 id="various-photos">Various photos</h2>
<h3 id="airgradient-packaging-and-boxes">AirGradient packaging and boxes</h3>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-package_hu5842976323371851708.jpg"
      
      alt="AirGradient package that looks manually packaged by hand and sent from Thailand."><figcaption>
        
        
        
        <p>AirGradient package that looks manually packaged by hand and sent from Thailand.</p>
      </figcaption>
  
  </figure>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-boxes_hu12167167564091679015.jpg"
      
      alt="Two boxes of AirGradient Pro DIY kit."><figcaption>
        
        
        
        <p>Two boxes of AirGradient Pro DIY kit.</p>
      </figcaption>
  
  </figure>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-box-open_hu4215509263566506080.jpg"
      
      alt="First look after opening the kit."><figcaption>
        
        
        
        <p>First look after opening the kit.</p>
      </figcaption>
  
  </figure>
<h3 id="airgradient">AirGradient</h3>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-on-wall.jpg"
      
      alt="AirGradient in action.
Yes, the CO2 is high, my room has bad air circulation.
Yes, the electric socket below has slight openings and is hazardous,
I need to fix it eventually."><figcaption>
        
        
        
        <p>AirGradient in action.
Yes, the CO2 is high, my room has bad air circulation.
Yes, the electric socket below has slight openings and is hazardous,
I need to fix it eventually.</p>
      </figcaption>
  
  </figure>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/airgradient-back-side_hu15779069383001675947.jpg"
      
      alt="Back side view of AirGradient. To avoid punching a hole in the wall, I&rsquo;m using knitting thread to hang the unit."><figcaption>
        
        
        
        <p>Back side view of AirGradient. To avoid punching a hole in the wall, I&rsquo;m using knitting thread to hang the unit.</p>
      </figcaption>
  
  </figure>
<h3 id="others">Others</h3>

  

  

  <figure><img
      loading="lazy" src="/p/airgradient/power-supply_hu13364198392539096612.jpg"
      
      alt="The 5V 3A power supply I&rsquo;m using for powering AirGradient."><figcaption>
        
        
        
        <p>The 5V 3A power supply I&rsquo;m using for powering AirGradient.</p>
      </figcaption>
  
  </figure>
<h2 id="changelog">Changelog</h2>
<ul>
<li>2023-10-13: add electricity usage</li>
<li>2023-09-08: initial version</li>
</ul>
<hr>
<p>Post 22 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://edition.cnn.com/2023/08/16/asia/indonesia-pollution-jokowi-cough-intl-hnk/index.html">https://edition.cnn.com/2023/08/16/asia/indonesia-pollution-jokowi-cough-intl-hnk/index.html</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://web.archive.org/web/20230909181316/https://www.tokopedia.com/ariatechnologies/indoor-air-quality-pm2-5-monitor-aria-airtest">https://web.archive.org/web/20230909181316/https://www.tokopedia.com/ariatechnologies/indoor-air-quality-pm2-5-monitor-aria-airtest</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://forum.airgradient.com/t/extending-the-life-span-of-the-pms5003-sensor/114/23#:~:text=We%20have%20many%20PMS5003%20still%20working%20after%20four%20years%20without%20issues.%20If%20you%20are%20not%20living%20in%20a%20very%20polluted%20environment%20they%20will%20probably%20last%20longer%20than%203%20years">https://forum.airgradient.com/t/extending-the-life-span-of-the-pms5003-sensor/114/23#:~:text=We%20have%20many%20PMS5003%20still%20working%20after%20four%20years%20without%20issues.%20If%20you%20are%20not%20living%20in%20a%20very%20polluted%20environment%20they%20will%20probably%20last%20longer%20than%203%20years</a>.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded></item><item><title>My First UPS</title><link>https://darcien.dev/p/my-first-ups/</link><pubDate>Fri, 03 Mar 2023 22:17:35 +0700</pubDate><guid>https://darcien.dev/p/my-first-ups/</guid><description>Bye-bye power outage, you won&amp;rsquo;t be missed üëã</description><content:encoded><![CDATA[<p>After 10 years of owning a desktop PC, I finally bought my first UPS!</p>
<p>Initially I planned to buy an UPS way earlier, but keep holding off from buying for various reasons.
It&rsquo;ll be hard to move places if I have UPS.
It probably won&rsquo;t solve my badly grounded wirings in my place.
What about compatibility with PFC active PSU?
Macbook chargers?
Oh no, the vendor recommends using cable under 2m from the socket to UPS for best operation.
I don&rsquo;t have that kind of close-to-floor sockets in my place.</p>
<p>Ah, fuck it. I&rsquo;m tired having my PC crashing down whenever there&rsquo;s power outage in my area.
That&rsquo;s what I thought last week.</p>
<p>I quickly search around and try to find which brand has decent quality and support in my country.
APC it is.
I still need to buy a watt-meter though to figure out which model buy.
Definitely buying a line interactive one though<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>After I&rsquo;m done measuring all my equipment watt usage, I decided to buy this guy, <a href="https://www.apc.com/ph/en/product/BVX1200LI-MS/apc-easy-ups-bvx-1200va-230v-avr-universal-sockets/">APC BVX1200LI-MS</a>.
Rated for 1200VA and max 650W.</p>
<p>Today, this bad boy arrived. So I&rsquo;m going to leave it to charge overnight and test it tomorrow morning.</p>

  

  

  <figure><img
      loading="lazy" src="/img/ups-apc.jpg"
      
      alt="Front side of the UPS."><figcaption>
        
        
        
        <p>Front look of the UPS.</p>
      </figcaption>
  
  </figure><script defer src="https://cdn.jsdelivr.net/npm/lightense-images@1.0.17/dist/lightense.min.js" integrity="sha256-0L7PA+rlAMaq+Gkzls+i1cUvY9i7D+XF/Yl3BhYKABo=" crossorigin="anonymous"></script>
  <script defer type="text/javascript">
    window.addEventListener("load", function() {
      Lightense('img:not(.no-lightense, [aria-label="logo"])', {
        
        
        
        background: 'rgb(155, 156, 157 / 60%)',
      });
    }, false);
  </script>
<hr>
<p>Test run done, work just fine under normal load so far.
It also free up 2 slot from my usual power strip, which is great!</p>
<hr>
<hr>
<p>Post 10 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://fitzcarraldoblog.wordpress.com/2020/08/09/that-ups-you-bought-for-your-home-server-may-not-be-as-useful-as-you-think/">This person bought a non-line interacive PSU</a>, which is not very useful according to their experience.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded></item><item><title>My First Pi-hole</title><link>https://darcien.dev/p/my-first-pi-hole/</link><pubDate>Mon, 12 Dec 2022 16:01:20 +0700</pubDate><guid>https://darcien.dev/p/my-first-pi-hole/</guid><description>Putting a 7 y.o. Raspbian model 2 to work.</description><content:encoded><![CDATA[<p>I bought my first Raspberry Pi at 2015, it was model 2.
I was an idealist and foolish college freshman at the time.
Things happened, and fast forward 7 years later, my Pi was collecting dust.
And here I am thinking want I want to do over the new year break.
So, as a QoL improvement to my home network, it might be nice to have a <a href="https://pi-hole.net/">Pi-hole</a>.</p>
<p>I&rsquo;m surprised the SD card is still alive and it&rsquo;s still running 2018&rsquo;s version Raspbian.
Hardware also looks good, so I proceed to nuke the SD card and install the latest OS.
Seems like Raspbian is no longer a thing, they have Raspberry Pi OS now<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>It didn&rsquo;t even take 3 hours to get everything running and working.
I expected it to take a lot more time as I&rsquo;m setting this up while having lunch.</p>
<ul>
<li>Raspberry OS download and write to SD (30 mins)
<ul>
<li>They have official imaging utility now, downloading the image and writing it to the SD card is a breeze now<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</li>
<li>My internet speed sucks though, so the download still take some time.</li>
</ul>
</li>
<li>Setup static IP for the Pi (needed for Pi-hole) (10 mins)
<ul>
<li>I hate the built-in interface of the ISP provided router with passion (it&rsquo;s Huawei from IndiHome BTW).
It is sluggish and hard to navigate.</li>
</ul>
</li>
<li>Install and set-up Pi-hole on the Pi (20 mins)
<ul>
<li>Pi-hole has install script, and that really helps saving some time<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.
Yes, running unknown script from the internet is dangerous, I understand the risk.</li>
</ul>
</li>
<li>Finding admin account for my ISP provided router (10 mins)
<ul>
<li>I just realized the admin user that I use cannot be used to change the DNS server settings.
Google here I go.
Thankfully I found an user I can use real quick, it&rsquo;s <code>telecomadmin</code><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>.</li>
</ul>
</li>
<li>Change default DNS server to Pi-hole in the home router (5 mins)</li>
<li>Test everything is working (60 mins and counting)</li>
</ul>
<p>So far it&rsquo;s working great!</p>

  

  

  <figure><img
      loading="lazy" src="/img/first-pi-hole-admin-console.png"
      
      alt="Admin console of Pi-hole"><figcaption>
        
        
        
        <p>I&rsquo;m feeling happy when looking at the queries blocked number going up.</p>
      </figcaption>
  
  </figure><script defer src="https://cdn.jsdelivr.net/npm/lightense-images@1.0.17/dist/lightense.min.js" integrity="sha256-0L7PA+rlAMaq+Gkzls+i1cUvY9i7D+XF/Yl3BhYKABo=" crossorigin="anonymous"></script>
  <script defer type="text/javascript">
    window.addEventListener("load", function() {
      Lightense('img:not(.no-lightense, [aria-label="logo"])', {
        
        
        
        background: 'rgb(155, 156, 157 / 60%)',
      });
    }, false);
  </script>
<p>I still need to figure out some things though:</p>
<ul>
<li>Why some query didn&rsquo;t go through Pi-hole?</li>
<li>How do I back up the SD card? The 7 y.o. SD card won&rsquo;t last forever.</li>
<li>Can I lower the Raspbian temperature? Making it sit in on top of a running router does not help at all.</li>
<li>Do I need to set up HTTPS for the console?</li>
<li>Should I set up my VPN to use Pi-hole as the DNS server? I&rsquo;m already using Tailscale for VPN and the Pi is connected to it. Maybe I&rsquo;ll have an answer after running Pi-hole for a month or so. Tailscale also have official guide <a href="https://tailscale.com/kb/1114/pi-hole/">here</a>, so this should be a supported use case.</li>
<li>Should I set up <a href="https://docs.pi-hole.net/guides/dns/unbound/">unbound</a>?</li>
</ul>
<p>Some blog posts that I found useful while setting up Pi-hole:</p>
<ul>
<li><a href="https://www.troyhunt.com/mmm-pi-hole/">&ldquo;Mmm&hellip; Pi-hole&hellip;&rdquo; by Troy Hunt</a></li>
<li><a href="https://scotthelme.co.uk/catching-naughty-devices-on-my-home-network/">&ldquo;Catching and dealing with naughty devices on my home network&rdquo; by Scott Helme</a></li>
<li><a href="https://www.crosstalksolutions.com/the-worlds-greatest-pi-hole-and-unbound-tutorial-2023">&ldquo;The World‚Äôs Greatest Pi-hole (and Unbound) Tutorial 2023&rdquo; by Crosstalk Solutions</a></li>
</ul>
<hr>
<p>Post 6 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p>
<hr>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.tomshardware.com/news/raspberry-pi-os-no-longer-raspbian">https://www.tomshardware.com/news/raspberry-pi-os-no-longer-raspbian</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.raspberrypi.com/software/">https://www.raspberrypi.com/software/</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/pi-hole/pi-hole/#one-step-automated-install">https://github.com/pi-hole/pi-hole/#one-step-automated-install</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://forum.huawei.com/enterprise/en/how-to-login-hg8245h/thread/762243-100181">https://forum.huawei.com/enterprise/en/how-to-login-hg8245h/thread/762243-100181</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded></item></channel></rss>