<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Road to NixOS: The Infection | A blog by Yosua Ian Sebastian</title>
<meta name=keywords content="nixos,linux,100DaysToOffload"><meta name=description content="The start of a journey; migrating a hobby server to NixOS."><meta name=author content="Yosua"><link rel=canonical href=https://darcien.dev/p/road-to-nixos-infection/><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=2"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=2"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=2"><link rel=manifest href="/site.webmanifest?v=2"><link rel=mask-icon href="/safari-pinned-tab.svg?v=2" color=#34343c><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/style.css rel="preload stylesheet" as=style><meta property="og:title" content="Road to NixOS: The Infection"><meta property="og:description" content="The start of a journey; migrating a hobby server to NixOS."><meta property="og:type" content="article"><meta property="og:url" content="https://darcien.dev/p/road-to-nixos-infection/"><meta property="article:section" content="p"><meta property="article:published_time" content="2023-07-03T15:46:46+00:00"><meta property="article:modified_time" content="2023-07-03T15:46:46+00:00"><meta property="og:site_name" content="A blog by Yosua Ian Sebastian"><meta name=twitter:card content="summary"><meta name=twitter:title content="Road to NixOS: The Infection"><meta name=twitter:description content="The start of a journey; migrating a hobby server to NixOS."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ps","item":"https://darcien.dev/p/"},{"@type":"ListItem","position":2,"name":"Road to NixOS: The Infection","item":"https://darcien.dev/p/road-to-nixos-infection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Road to NixOS: The Infection","name":"Road to NixOS: The Infection","description":"The start of a journey; migrating a hobby server to NixOS.","keywords":["nixos","linux","100DaysToOffload"],"articleBody":"Disclaimer: This series is not a guide nor a walkthrough for NixOS. This is intended to be a public notes of my journey here.\nWhy? Indo’s goverment announced extended holiday for 28-30 June 20231. This gives me unexpected free time. So I decided to tinker with NixOS. Migrating an existing Ubuntu 18 hobby server that has a bunch of services running in it should be enough learning material.\nToe Dipping Before renting a cloud host, I want to try NixOS locally first. What I tried:\nNixOS on WSL This kinda work thanks to community effort in NixOS-WSL. There are plethora of issues stemming from WSL. Most of them have known workaround, so I kept trying. Until docker happened. I couldn’t connect to docker container running in NixOS from Windows. The maintainer of NixOS-WSL seems to experience the same issue2. I’m not familiar enough with WSL and NixOS to debug this, dropping…\nNixOS as guest VM (VirtualBox) I have a bunch of ancient Arch Linux VMs here, they all work great. Then NixOS should work just fine right? Well yes, until I tried to reboot the NixOS. Seems like the drive where NixOS is not bootable? I don’t think it’s because I used the minimal NixOS image when installing, instead of using the one with desktop environment included.\nI was proven wrong. After reading the manual again, the minimal image boots into the installer, not an installed NixOS3. Following the manual seems easy enough, but I doubt it’s worth to do on a throwaway VM.\nNixOS-Infect entered the room What is this? A script to install NixOS on non-NixOS hosts.\nNixOS-Infect is so named because of the high likelihood of rendering a system inoperable. Use with extreme caution and preferably only on newly provisioned systems.\nhttps://github.com/elitak/nixos-infect\nI stumbled over this when searching around NixOS. And seeing nixos-infect support the latest LTS Ubuntu (22.04 atm) on Digital Ocean is trigger to use this instead of VM on my desktop.\nSo I went ahead and created a new droplet, AMD CPU + 2 GB RAM. Along this, I also learnt “user data” which can be used to run script on droplet creation. Specifically I need the user data to run the infect script.\nWhile waiting for the infect script to finish, I learnt few tricks like how to make less follow the tail like docker logs4.\nless +F /tmp/infect.log By the time I looked at the log again, it is already rebooting, which is a good sign!\nFast forward few frames…\nI tried ssh-ing to the droplet using root user… it worked, I’m in!\nFrom this point, it’s all tinkering with the config, learning Nix language, and a lot of sudo nixos-rebuild switch.\nClosing Thoughts I’m writing this from the NixOS droplet. So far I’m really happy with the result.\nYears ago I set up Arch Linux on a bunch of old laptops and desktops but didn’t write anything after it. This time I’m determined to leave some notes on the new journey.\nNext post is about making the NixOS more sane as dev environment!\nPost 17 of #100DaysToOffload.\nhttps://web.archive.org/web/20230703173600/https://en.tempo.co/read/1739780/govt-announces-2-eid-al-adha-joint-leave-days-jokowi-confirms ↩︎\nhttps://github.com/nix-community/NixOS-WSL/issues/235#issuecomment-1575977960 ↩︎\nhttps://nixos.org/manual/nixos/stable/index.html#sec-installation-manual ↩︎\nhttps://unix.stackexchange.com/a/474 ↩︎\n","wordCount":"520","inLanguage":"en","datePublished":"2023-07-03T15:46:46Z","dateModified":"2023-07-03T15:46:46Z","author":{"@type":"Person","name":"Yosua"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://darcien.dev/p/road-to-nixos-infection/"},"publisher":{"@type":"Organization","name":"A blog by Yosua Ian Sebastian","logo":{"@type":"ImageObject","url":"https://darcien.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://darcien.dev/ accesskey=h title="Yosua Ian Sebastian (Alt + H)"><img src=https://darcien.dev/whale_goth.svg alt aria-label=logo height=28>Yosua Ian Sebastian</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://darcien.dev/now title=now><span>now</span></a></li><li><a href=https://darcien.dev/about title=about><span>about</span></a></li><li><a href=https://darcien.dev/uses title=uses><span>uses</span></a></li><li><a href=https://darcien.dev/archive title=archive><span>archive</span></a></li><li><a href=https://darcien.dev/tags title=tags><span>tags</span></a></li><li><a href=https://darcien.dev/search title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://status.darcien.dev/ title=status><span>status</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Road to NixOS: The Infection</h1><div class=post-meta><span title='2023-07-03 15:46:46 +0000 UTC'>2023-07-03</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;520 words&nbsp;·&nbsp;Yosua</div></header><div class=post-content><p>Disclaimer: This series is not a guide nor a walkthrough for NixOS.
This is intended to be a public notes of my journey here.</p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>Indo&rsquo;s goverment announced extended holiday for 28-30 June 2023<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
This gives me unexpected free time.
So I decided to tinker with NixOS.
Migrating an existing Ubuntu 18 hobby server that has a bunch of services
running in it should be enough learning material.</p><h2 id=toe-dipping>Toe Dipping<a hidden class=anchor aria-hidden=true href=#toe-dipping>#</a></h2><p>Before renting a cloud host, I want to try NixOS locally first.
What I tried:</p><h3 id=nixos-on-wsl>NixOS on WSL<a hidden class=anchor aria-hidden=true href=#nixos-on-wsl>#</a></h3><p>This kinda work thanks to community effort in <a href=https://github.com/nix-community/NixOS-WSL>NixOS-WSL</a>.
There are plethora of issues stemming from WSL.
Most of them have known workaround,
so I kept trying.
Until docker happened.
I couldn&rsquo;t connect to docker container running in NixOS from Windows.
The maintainer of NixOS-WSL seems to experience the same issue<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.
I&rsquo;m not familiar enough with WSL and NixOS to debug this, dropping&mldr;</p><h3 id=nixos-as-guest-vm-virtualbox>NixOS as guest VM (VirtualBox)<a hidden class=anchor aria-hidden=true href=#nixos-as-guest-vm-virtualbox>#</a></h3><p>I have a bunch of ancient Arch Linux VMs here, they all work great.
Then NixOS should work just fine right?
Well yes, until I tried to reboot the NixOS.
Seems like the drive where NixOS is not bootable?
I don&rsquo;t think it&rsquo;s because I used the minimal NixOS image when installing,
instead of using the one with desktop environment included.</p><p>I was proven wrong.
After reading the manual again, the minimal image boots into the installer,
not an installed NixOS<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.
Following the manual seems easy enough,
but I doubt it&rsquo;s worth to do on a throwaway VM.</p><h2 id=nixos-infect-entered-the-room>NixOS-Infect entered the room<a hidden class=anchor aria-hidden=true href=#nixos-infect-entered-the-room>#</a></h2><blockquote><h3 id=what-is-this>What is this?<a hidden class=anchor aria-hidden=true href=#what-is-this>#</a></h3><p>A script to install NixOS on non-NixOS hosts.</p><p>NixOS-Infect is so named because of the high likelihood of rendering a system inoperable. Use with extreme caution and preferably only on newly provisioned systems.</p><p><a href=https://github.com/elitak/nixos-infect>https://github.com/elitak/nixos-infect</a></p></blockquote><p>I stumbled over this when searching around NixOS.
And seeing nixos-infect support the latest LTS Ubuntu (22.04 atm)
on Digital Ocean is trigger to use this instead of VM on my desktop.</p><p>So I went ahead and created a new droplet, AMD CPU + 2 GB RAM.
Along this, I also learnt &ldquo;user data&rdquo; which can be used to run script
on droplet creation.
Specifically I need the user data to run the infect script.</p><p>While waiting for the infect script to finish,
I learnt few tricks like
how to make <code>less</code> follow the tail like docker logs<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>less +F /tmp/infect.log
</span></span></code></pre></div><p>By the time I looked at the log again, it is already rebooting,
which is a good sign!</p><p>Fast forward few frames&mldr;</p><p>I tried ssh-ing to the droplet using root user&mldr; it worked, I&rsquo;m in!</p><p>From this point, it&rsquo;s all tinkering with the config, learning Nix language, and
a lot of <code>sudo nixos-rebuild switch</code>.</p><h2 id=closing-thoughts>Closing Thoughts<a hidden class=anchor aria-hidden=true href=#closing-thoughts>#</a></h2><p>I&rsquo;m writing this from the NixOS droplet.
So far I&rsquo;m really happy with the result.</p><p>Years ago I set up Arch Linux on a bunch of old laptops and desktops but didn&rsquo;t
write anything after it.
This time I&rsquo;m determined to leave some notes on the new journey.</p><p>Next post is about making the NixOS more sane as dev environment!</p><hr><p>Post 17 of <a href=https://100daystooffload.com/>#100DaysToOffload</a>.</p><hr><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://web.archive.org/web/20230703173600/https://en.tempo.co/read/1739780/govt-announces-2-eid-al-adha-joint-leave-days-jokowi-confirms>https://web.archive.org/web/20230703173600/https://en.tempo.co/read/1739780/govt-announces-2-eid-al-adha-joint-leave-days-jokowi-confirms</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/nix-community/NixOS-WSL/issues/235#issuecomment-1575977960>https://github.com/nix-community/NixOS-WSL/issues/235#issuecomment-1575977960</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://nixos.org/manual/nixos/stable/index.html#sec-installation-manual>https://nixos.org/manual/nixos/stable/index.html#sec-installation-manual</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://unix.stackexchange.com/a/474>https://unix.stackexchange.com/a/474</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://darcien.dev/tags/nixos/>nixos</a></li><li><a href=https://darcien.dev/tags/linux/>linux</a></li><li><a href=https://darcien.dev/tags/100daystooffload/>100DaysToOffload</a></li></ul><nav class=paginav><a class=prev href=https://darcien.dev/p/road-to-nixos-install-programs/><span class=title>« Prev</span><br><span>Road to NixOS: How do I install programs?</span>
</a><a class=next href=https://darcien.dev/p/actual-prices-for-goods-from-booth/><span class=title>Next »</span><br><span>Buying T-shirt from BOOTH.pm from Indo (still) Expensive</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 A blog by Yosua Ian Sebastian</span><br><span>Blog logo is a recolored <a target=_blank referrerpolicy=no-referrer rel=noopener href=https://twemoji.twitter.com/>Spouting Whale Twemoji</a> by Twitter, Inc
and other contributors and is licensed under <a target=_blank referrerpolicy=no-referrer rel=noopener href=https://creativecommons.org/licenses/by/4.0/>CC-BY
4.0</a></span><div class=footer-blank>This space intentionally left blank.</div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>