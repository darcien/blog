<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Monitoring air quality with AirGradient and Home Assistant | A blog by Yosua Ian Sebastian</title><meta name=keywords content="homesetup,100DaysToOffload"><meta name=description content="My journey for better air quality."><meta name=author content="Yosua"><link rel=canonical href=https://darcien.dev/p/airgradient/><link crossorigin=anonymous href=/assets/css/stylesheet.af4641ce48a747a666fc5670ecf1ca0b28f7fbaad47ea6f82ebf08649e6b028a.css integrity="sha256-r0ZBzkinR6Zm/FZw7PHKCyj3+6rUfqb4Lr8IZJ5rAoo=" rel="preload stylesheet" as=style><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=2"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=2"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=2"><link rel=manifest href="/site.webmanifest?v=2"><link rel=mask-icon href="/safari-pinned-tab.svg?v=2" color=#34343c><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=alternate hreflang=en href=https://darcien.dev/p/airgradient/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/style.css rel="preload stylesheet" as=style><meta property="og:url" content="https://darcien.dev/p/airgradient/"><meta property="og:site_name" content="A blog by Yosua Ian Sebastian"><meta property="og:title" content="Monitoring air quality with AirGradient and Home Assistant"><meta property="og:description" content="My journey for better air quality."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="p"><meta property="article:published_time" content="2023-09-08T20:46:41+07:00"><meta property="article:modified_time" content="2023-09-08T20:46:41+07:00"><meta property="article:tag" content="Homesetup"><meta property="article:tag" content="100DaysToOffload"><meta name=twitter:card content="summary"><meta name=twitter:title content="Monitoring air quality with AirGradient and Home Assistant"><meta name=twitter:description content="My journey for better air quality."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ps","item":"https://darcien.dev/p/"},{"@type":"ListItem","position":2,"name":"Monitoring air quality with AirGradient and Home Assistant","item":"https://darcien.dev/p/airgradient/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Monitoring air quality with AirGradient and Home Assistant","name":"Monitoring air quality with AirGradient and Home Assistant","description":"My journey for better air quality.","keywords":["homesetup","100DaysToOffload"],"articleBody":" üîñ Assumed post audience: someone who wants to know what it takes to setup self hosted air quality monitor.\nRecently I pulled the trigger and bought air quality monitor from AirGradient. Definitely not because my city has plummeted from bad to worst1.\nThis post will contain everything I did to set up AirGradient, all the way to storing and viewing historical data locally.\nWhat parts/components/tools are used? For air monitoring AirGradient DIY Pro, I bought 2 units, pre-soldered kit. My kit includes: Pro PCB version 4.2 ESP8266 WeMos D1 mini v4 microcontroller Senseair S8 CO2 sensor Plantower PMS5003 PM sensor Sensirion SGP41 VOC and NOx sensor Sensirion SHT40 temperature and humidity sensor SH1106 128x64 1.3\" OLED display USB-C 2m cable plastic enclosure, screws, and (small) screwdriver Power supply, 5V 3A. This forum post mention they recommend 5V and at least 2.4A for WeMos D1 used in the pro kit. I could only find made-in-China power supplies here, it‚Äôs better than nothing. USB cable, 3m, USB-A to USB-C with right angle so it can fit behind the air monitor. The supplied 2m cable is not enough for me. 3M adhesive hooks and random knitting threads. Using plastic hooks + threads so I don‚Äôt have to put a hole in the wall to hang the air monitor. For storing and viewing sensor data TL;DR I‚Äôm using Home Assistant container on old MacBook for local server.\nAirGradient has their own home server to host the data sent from the sensor. I got free 2 year subscription for their server from buying their pro kit.\nThat means:\nI need 24/7 internet connection to send the data, and sending all sensor data to uncontrolled server üôÅ. I don‚Äôt really like that idea, so I will need my own local server to handle the sensor data. And reflash the AirGradient microcontroller to send the data to my server instead.\nSearching the internet leads me to Home Assistant (HA) + ESPHome setup.\nMy options for hosting HA are:\nreuse Raspberry Pi 2 model B that already runs Pi-hole, use old 15\" MacBook from 2015, use cheapo 14\" Lenovo laptop from 2015 (it runs Arch btw), reuse cloud VM (small droplet in SG region that runs NixOS), buy ready-to-use Home Assistant server, buy new Raspberry Pi 4 I went through the possible HA installation methods to cross-check which host should I use for HA.\nPossible HA installation methods are:\nSupervised: this requires strict dependencies setup and maintaining them, no go. OS: this requires wiping the host OS or running VM inside the host, which requires non-trivial overhead for CPU consumption etc. Keen to avoid this. Core: oh it‚Äôs Python, sorry but I do not want to manage Python installation, no go. Container: this require a container environment and running a built HA image. Container installation is the most sane setup for me, so I‚Äôm going with it. (Later on I realized HA container cannot use HA add-ons. That means I cannot use ESPHome HA add-ons to make things easier. But that is fine, I could live without the add-ons.)\nGoing back to my hosting choices and by the process of elimination:\nRaspberry Pi 2 probably won‚Äôt be strong enough, HA recommends Pi 3 or 4. So, no go. (I saw some people tried running HA on Pi 2B, it‚Äôs kinda hit and miss.) Cloud VM probably will work, but requires internet connection. Keeping this as last resort. HA Yellow, I checked the price from the Chinese supplier, it‚Äôs going to cost 179 USD or more, not including shipping and tax. No thanks, that‚Äôs too expensive for me. New Raspberry Pi 4: The official supplier is either gone or out of stock here. And there‚Äôs only scalper with crazy price tag in local marketplace. No thanks. Old laptops, these are my best bets for now. At the end, I picked the MacBook over Lenovo since it has better CPU. It runs macOS 12 and the UI is a bit laggy, but it should be good enough since I‚Äôm only accessing it via SSH anyway.\nFor flashing the microcontroller I need to reflash the D1 mini to make it send data to my server. I have no idea how to do it though, reading ESPHome website feels overwhelming at first. After furiously reading the docs, FAQ, and a mug of coffee, I think I get it.\nWith ESPHome, you:\nwrite declarative config (in YAML) for the micrcontroller firmware instead of writing the code directly. use ESPHome CLI to compile the YAML config into a runnable firmware and upload it to the microcontroller. I will be using Docker on macOS to run ESPHome and according to this, I won‚Äôt be able to flash via USB cable. So I will need to use ESPHome‚Äôs web flasher.\nWhat work are done to start seeing numbers in dashboard? Assembling the AirGradient kit AirGradient has the full assembly instruction in their website. Mine is pretty straightforward since I bought the pre-soldered kit which involves sticking sensor to the correct places.\nPre-soldered AirGradient kit that comes with the display and PM sensor already attached.\nFully assembled kit, with everything sticked in.\nSanity checking the kit Power on the kit by connecting to power supply. Make sure everything is looks good, sensors and display are working. Better do this before screwing the enclosure tightly.\nI don‚Äôt have other sensor for baseline of the installed sensors though. So I can‚Äôt sense check the sensor values.\nFlashing the microcontroller Connect the microcontroller directly to a computer with USB cable. Connecting the cable to the PCB will not work! Open up web flasher. In the flasher, press connect and pick the microcontroller and connect. On mine, it says ‚ÄúUSB Serial (cu.usbserial-1120)‚Äù. Yours might be different. Press ‚ÄúPREPARE FOR FIRST USE‚Äù. Read the explanation first and install after understanding it. Wait for it to finish installing. After done installing, continue setting up Wi-Fi for the device in the flasher. This will allow us to flash over the network. If everything works fine, you should be able to access the web server hosted in the microcontoller by accessing the device IP directly. At this point we can start writing ESPHome config be flashed over the network. I would expect myself taking months to finish writing the config. Thankfully a nice person has shared their config in the internet, like this one. I end up using this config from @ex-nerd‚Äôs PR. Specifically this file that‚Äôs intended for AirGradient Pro version 4.2.\nSteps I did for compiling the firmware:\nCopy the AirGradient config YAML and secrets.yaml, save them in a new directory somewhere in the computer. Modify the config as needed, the instruction comments in there is pretty self explanatory. While editing the YAML, the editor IDE might complain about ‚ÄúUnresolved tag: !secret‚Äù. It‚Äôs fine to ignore those warnings. Those are HA config specifics that is also supported by ESPHome. Fill in the variables in the secrets.yaml. For the home_assistant_encryption_key, it needs to be base64 string. The docs page from ESPHome has a generator for it. ‚úÖ Make sure to backup secrets.yaml, otherwise you will need to reflash if you lose access.\nRun ESPHome CLI to compile and upload the firmware to the microcontroller. I‚Äôm using Docker to run it, so mine looks like this: docker run --rm -v \"${PWD}\":/config -it ghcr.io/esphome/esphome run air-gradient-pro-diy.yaml. In my case, the upload step failed because esphome unable to find my device. Error log:\n... Linking .pioenvs/airgradient-pro-0/firmware.elf RAM: [===== ] 49.3% (used 40392 bytes from 81920 bytes) Flash: [====== ] 64.7% (used 675549 bytes from 1044464 bytes) Building .pioenvs/airgradient-pro-0/firmware.bin esp8266_copy_factory_bin([\".pioenvs/airgradient-pro-0/firmware.bin\"], [\".pioenvs/airgradient-pro-0/firmware.elf\"]) ================================================================================= [SUCCESS] Took 536.00 seconds ================================================================================= INFO Successfully compiled program. INFO Resolving IP address of airgradient-pro-0.local ERROR Error resolving IP address of airgradient-pro-0.local. Is it connected to WiFi? ERROR (If this error persists, please set a static IP address: https://esphome.io/components/wifi.html#manual-ips) ERROR Error resolving IP address: Error resolving address with mDNS: Did not respond. Maybe the device is offline., [Errno -3] Temporary failure in name resolution So I had to setup static IP in the config and rerun the docker command.\nwifi: ... manual_ip: # Set this to the IP of the ESP static_ip: \"192.168.100.152\" # Set this to the IP address of the router. Often ends with .1 gateway: \"192.168.100.1\" # The subnet of the network. 255.255.255.0 works for most home networks. subnet: \"255.255.255.0\" After rerunning the compile command and a successful uploads, the CLI will start streaming the logs from the device nonstop. Success logs:\n... INFO Successfully compiled program. INFO Connecting to 192.168.100.152 INFO Uploading .esphome/build/airgradient-pro-1/.pioenvs/airgradient-pro-1/firmware.bin (680288 bytes) INFO Compressed to 475364 bytes Uploading: [============================================================] 100% Done... INFO Waiting for result... INFO OTA successful INFO Successfully uploaded program. INFO Starting log output from 192.168.100.152 using esphome API INFO Successfully connected to 192.168.100.152 [19:48:18][I][app:102]: ESPHome version 2023.8.2 compiled on Sep 8 2023, 19:46:22 ... Can terminate the CLI safely after upload succeeds and it start streaming the logs.\nThe display should also lit up and start showing the pages specified in the config YAML. Some of sensor numbers might show up as N/A for a while. I haven‚Äôt debugged this, but after leaving it powered on for few mins, N/A got replaced with numbers. So the sensors might be just starting and simply haven‚Äôt picked up and sent any data yet.\nNow we have the sensors ready to send data, it‚Äôs time to setup the receiving part!\nSetting up Home Assistant container MacOS HA installation docs actually does not have container installation. Luckily prior to this, I already found this post from Ixion about setting up Home Assistant on macOS. I accidentally found that post when trying to find a way to run HA VM image using Lima, with the lima keyword accidentally matching on the colima used in the post.\nWhat I did to set up HA is exactly as described in Ixion‚Äôs post, summarized as:\nInstall Colima and Docker on macOS (using brew) Start Colima Configure Colima to use the host network Install Home Assistant on Docker Set up Home Assistant https://blog.illixion.com/2023/04/colima-home-assistant/\nWith some exceptions:\nWhen configuring Lima to use socket_vmnet, my path for socket_vmnet is different. I had to a bit of manual cd and ls ritual, and found mine on /usr/local/opt/socket_vmnet/bin/socket_vmnet instead of /opt/homebrew/bin/socket_vmnet. I just learned brew has subcommand for finding the path, brew info , e.g. brew info socket_vmnet and it will spit out the installation path. When opening the network settings in HA, mine is blank. Turns out I need to turn on ‚ÄúAdvanced Mode‚Äù in my HA profile. After that, I can open the network settings and pick lima0 network adapter. Before realizing that, I thought the network settings is not accessible remotely. I tried accessing from localhost by port forwarding the dashboard, it didn‚Äôt help at all. Connecting AirGradient with Home Assistant According to this HA docs, HA should be able to automatically discover a running ESPHome device in the same network. I have not tried it. Instead I tried manually adding the ESPHome device or in this case the AirGradient to HA.\nFrom the HA dashboard, do:\nOpen ‚ÄúSettings \u003e Devices \u0026 Services‚Äù, In ‚ÄúIntegrations‚Äù tab, press ‚ÄúADD INTEGRATION‚Äù in bottom right, Search and click ‚ÄúESPHome‚Äù integration, Put the AirGradient IP in the host field, keep the default 6053 port, and submit. If HA can find and connect to AirGradient, it will ask for encryption key. Paste in the home_assistant_encryption_key configured in secrets.yaml that‚Äôs used for flashing the AirGradient. That‚Äôs all! I can see my AirGradient sensors in HA dashboard.\nMy HA dashboard after connecting one AirGradient kit.\nWhy I‚Äôm getting Can't connect to ESP. when connecting AirGradient to HA? Make sure AirGradient is discoverable from HA.\nIn my case, I was accessing HA dashboard via Tailscale Magic DNS. So my dashboard URL looks like: http://unicorn:8123. And when adding AirGradient, I keep getting Can't connect to ESP. error even with the correct IP. After using SSH tunnel to expose the dashboard as: http://localhost:8123, adding AirGradient worked!\nThe tunnel command looked something like this:\nssh -L 8123:localhost:8123 -N -T darcien@unicorn My HA container does not expose any address in colima list! Try doing colima restart, and restart the HA container. Also check the container log for more clue.\nRestarting HA container with colima restart failed! In my case, colima gives a nice hint:\n‚ùØ colima restart INFO[0000] stopping colima INFO[0000] not running context=vm INFO[0000] done INFO[0003] starting colima INFO[0003] runtime: docker INFO[0003] preparing network ... context=vm INFO[0003] starting ... context=vm \u003e Using the existing instance \"colima\" \u003e can't read \"/private/etc/sudoers.d/lima\": failed to run [sudo --user daemon --group everyone --non-interactive true]: exit status 1 (Hint: run `limactl sudoers \u003eetc_sudoers.d_lima \u0026\u0026 sudo install -o root etc_sudoers.d_lima \"/private/etc/sudoers.d/lima\"`)) FATA[0003] error starting vm: error at 'starting': exit status 1 It was a permission issue, and running the command specified in the hint fixed it.\nlimactl sudoers \u003eetc_sudoers.d_lima \u0026\u0026 sudo install -o root etc_sudoers.d_lima \"/private/etc/sudoers.d/lima\" How much does it cost total? Parts Price (IDR) AirGradient Pro DIY (pre-soldered) x 2 4.544.100 AirGradient import tax 294.400 Power supply 5V 3A x 2 271.700 USB-C 3m cable 93.500 3M plastic hook x2 29.640 Old MacBook 0 ‚Äî ‚Äî Total 5.233.340 Using 1 USD = 14850 IDR conversion for AirGradient price calculation.\nIt‚Äôs a bit expensive for your average Indonesian, but still pretty good price when compared to commercial air monitor sold here, like this AirTest from Aria Indonesia. The AirTest only have PM2.5 sensor, no idea what specific sensor is installed in it. It is sold at 1.990.000 IDR and have 30 days pre-order2, now that‚Äôs expensive for a single sensor with closed design.\nHow much electricity does this setup use? A power meter showing 0.945 KWh after 6 days 15 hours 10 minutes for the server (from empty battery).\n0.945 KWh = 6 days 15 hours 10 minutes\n0.945 KWh = 9550 minutes\n0.006 KWh = 60 minutes\nThat‚Äôs 0.006 KWh per hour, or 4.32 KWh per month. So I‚Äôm paying around 6.241 IDR per month using 1.444,7 IDR per KWh rate.\nI‚Äôm excluding the electricity usage from the sensors because they‚Äôre too low. Leaving the metered sensors a week gave me 0 KWh on the power meter.\nWhat is the gfonts:// in the ESPHome config? It‚Äôs a special ESPHome syntax for using Google Fonts in the display.\nHow long until the sensors needs to be replaced? I‚Äôm not too sure yet. I‚Äôm seeing some discussion about this in AirGradient forum, and AirGradient said they still have PMS5003 sensor working even after 4 years3. I sure hope Jakarta‚Äôs air is not polluted enough to the point I need to replace PM sensors often. At that point, sensor life expectancy is the least of my worries.\nBack up plans for HA container? As I just finished with setting up, I have no concrete plans yet. I looked a bit into the forum and found this thread which has various approaches. Standing up an automatic backup most likely won‚Äôt be a 5 minutes job, so I will need to revisit this later.\nHow accurate is the PM sensors used? i.e. PMS5003 I learnt from this post that PMS5003 is using approximation for PM2.5 and PM10, and is only accurate for PM1. Well fortunately, the in-depth explanation proves PMS5003 is good enough for urban environment that doesn‚Äôt change too much like my bedroom and livingroom!\nVarious photos AirGradient packaging and boxes AirGradient package that looks manually packaged by hand and sent from Thailand.\nTwo boxes of AirGradient Pro DIY kit.\nFirst look after opening the kit.\nAirGradient AirGradient in action. Yes, the CO2 is high, my room has bad air circulation. Yes, the electric socket below has slight openings and is hazardous, I need to fix it eventually.\nBack side view of AirGradient. To avoid punching a hole in the wall, I‚Äôm using knitting thread to hang the unit.\nOthers The 5V 3A power supply I‚Äôm using for powering AirGradient.\nChangelog 2023-10-13: add electricity usage 2023-09-08: initial version Post 22 of #100DaysToOffload.\nhttps://edition.cnn.com/2023/08/16/asia/indonesia-pollution-jokowi-cough-intl-hnk/index.html¬†‚Ü©Ô∏é\nhttps://web.archive.org/web/20230909181316/https://www.tokopedia.com/ariatechnologies/indoor-air-quality-pm2-5-monitor-aria-airtest¬†‚Ü©Ô∏é\nhttps://forum.airgradient.com/t/extending-the-life-span-of-the-pms5003-sensor/114/23#:~:text=We%20have%20many%20PMS5003%20still%20working%20after%20four%20years%20without%20issues.%20If%20you%20are%20not%20living%20in%20a%20very%20polluted%20environment%20they%20will%20probably%20last%20longer%20than%203%20years.¬†‚Ü©Ô∏é\n","wordCount":"2659","inLanguage":"en","datePublished":"2023-09-08T20:46:41+07:00","dateModified":"2023-09-08T20:46:41+07:00","author":{"@type":"Person","name":"Yosua"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://darcien.dev/p/airgradient/"},"publisher":{"@type":"Organization","name":"A blog by Yosua Ian Sebastian","logo":{"@type":"ImageObject","url":"https://darcien.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://darcien.dev/ accesskey=h title="Yosua Ian Sebastian (Alt + H)"><img src=https://darcien.dev/whale_goth.svg alt aria-label=logo height=28>Yosua Ian Sebastian</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://darcien.dev/now title=now><span>now</span></a></li><li><a href=https://darcien.dev/about title=about><span>about</span></a></li><li><a href=https://darcien.dev/uses title=uses><span>uses</span></a></li><li><a href=https://darcien.dev/archive title=archive><span>archive</span></a></li><li><a href=https://darcien.dev/tags title=tags><span>tags</span></a></li><li><a href=https://darcien.dev/search title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Monitoring air quality with AirGradient and Home Assistant</h1><div class=post-meta><span title='2023-09-08 20:46:41 +0700 +0700'>2023-09-08</span>&nbsp;¬∑&nbsp;13 min&nbsp;¬∑&nbsp;2659 words&nbsp;¬∑&nbsp;Yosua</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#what-partscomponentstools-are-used>What parts/components/tools are used?</a><ul><li><a href=#for-air-monitoring>For air monitoring</a></li><li><a href=#for-storing-and-viewing-sensor-data>For storing and viewing sensor data</a></li><li><a href=#for-flashing-the-microcontroller>For flashing the microcontroller</a></li></ul></li><li><a href=#what-work-are-done-to-start-seeing-numbers-in-dashboard>What work are done to start seeing numbers in dashboard?</a><ul><li><a href=#assembling-the-airgradient-kit>Assembling the AirGradient kit</a></li><li><a href=#sanity-checking-the-kit>Sanity checking the kit</a></li><li><a href=#flashing-the-microcontroller>Flashing the microcontroller</a></li><li><a href=#setting-up-home-assistant-container>Setting up Home Assistant container</a></li><li><a href=#connecting-airgradient-with-home-assistant>Connecting AirGradient with Home Assistant</a></li></ul></li><li><a href=#why-im-getting-cant-connect-to-esp-when-connecting-airgradient-to-ha>Why I&rsquo;m getting <code>Can't connect to ESP.</code> when connecting AirGradient to HA?</a></li><li><a href=#my-ha-container-does-not-expose-any-address-in-colima-list>My HA container does not expose any address in <code>colima list</code>!</a></li><li><a href=#restarting-ha-container-with-colima-restart-failed>Restarting HA container with <code>colima restart</code> failed!</a></li><li><a href=#how-much-does-it-cost-total>How much does it cost total?</a></li><li><a href=#how-much-electricity-does-this-setup-use>How much electricity does this setup use?</a></li><li><a href=#what-is-the-gfonts-in-the-esphome-config>What is the <code>gfonts://</code> in the ESPHome config?</a></li><li><a href=#how-long-until-the-sensors-needs-to-be-replaced>How long until the sensors needs to be replaced?</a></li><li><a href=#back-up-plans-for-ha-container>Back up plans for HA container?</a></li><li><a href=#how-accurate-is-the-pm-sensors-used-ie-pms5003>How accurate is the PM sensors used? i.e. PMS5003</a></li><li><a href=#various-photos>Various photos</a><ul><li><a href=#airgradient-packaging-and-boxes>AirGradient packaging and boxes</a></li><li><a href=#airgradient>AirGradient</a></li><li><a href=#others>Others</a></li></ul></li><li><a href=#changelog>Changelog</a></li></ul></nav></div></details></div><div class=post-content><blockquote><p>üîñ Assumed post audience: someone who wants to know what it takes to setup
self hosted air quality monitor.</p></blockquote><p>Recently I pulled the trigger and bought air quality monitor from <a href=https://www.airgradient.com/>AirGradient</a>.
Definitely not because my city has plummeted from bad to worst<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>This post will contain everything I did to set up AirGradient, all the way
to storing and viewing historical data locally.</p><h2 id=what-partscomponentstools-are-used>What parts/components/tools are used?<a hidden class=anchor aria-hidden=true href=#what-partscomponentstools-are-used>#</a></h2><h3 id=for-air-monitoring>For air monitoring<a hidden class=anchor aria-hidden=true href=#for-air-monitoring>#</a></h3><ul><li><a href=https://www.airgradient.com/indoor/>AirGradient DIY Pro</a>, I bought 2 units, pre-soldered kit.
My kit includes:<ul><li>Pro PCB version 4.2</li><li><a href=https://www.wemos.cc/en/latest/d1/d1_mini.html>ESP8266 WeMos D1 mini v4 microcontroller</a></li><li><a href=https://senseair.com/products/size-counts/s8-residential/>Senseair S8 CO2 sensor</a></li><li><a href=https://www.plantower.com/en/products_33/74.html>Plantower PMS5003 PM sensor</a></li><li><a href=https://www.sensirion.com/products/catalog/SGP41/>Sensirion SGP41 VOC and NOx sensor</a></li><li><a href=https://sensirion.com/products/catalog/SHT40>Sensirion SHT40 temperature and humidity sensor</a></li><li><a href=https://www.smart-prototyping.com/1_3-inch-OLED-Display-SH1106-SPI-I2C-128-64>SH1106 128x64 1.3" OLED display</a></li><li>USB-C 2m cable</li><li>plastic enclosure, screws, and (small) screwdriver</li></ul></li><li>Power supply, 5V 3A. This <a href="https://web.archive.org/web/20230908145102/https://forum.airgradient.com/t/pro-kit-power-supply-requirements/374/3#:~:text=For%20the%20D1%20v4%20we%20recommend%205v%20and%20at%20least%202.4A.">forum post</a> mention they recommend 5V and at least 2.4A for WeMos D1 used in the pro kit. I could only find made-in-China power supplies here, it&rsquo;s better than nothing.</li><li>USB cable, 3m, USB-A to USB-C with right angle so it can fit behind the air monitor. The supplied 2m cable is not enough for me.</li><li><a href=https://www.3m.com/3M/en_US/p/c/home/storage-organization/clips-hooks-adhesive-strips/>3M adhesive hooks</a> and random knitting threads. Using plastic hooks + threads so I don&rsquo;t have to put a hole in the wall to hang the air monitor.</li></ul><h3 id=for-storing-and-viewing-sensor-data>For storing and viewing sensor data<a hidden class=anchor aria-hidden=true href=#for-storing-and-viewing-sensor-data>#</a></h3><blockquote><p>TL;DR I&rsquo;m using Home Assistant container on old MacBook for local server.</p></blockquote><p>AirGradient has their own home server to host the data sent from the sensor.
I got free 2 year subscription for their server from buying their pro kit.</p><p>That means:</p><ul><li>I need 24/7 internet connection to send the data,</li><li>and sending all sensor data to uncontrolled server üôÅ.</li></ul><p>I don&rsquo;t really like that idea, so I will need my own local server to handle the sensor data.
And reflash the AirGradient microcontroller to send the data to my server instead.</p><p><a href=https://forum.airgradient.com/t/airgradient-integrations/703>Searching</a> <a href=https://forum.airgradient.com/t/airgradient-esphome-setup-with-home-assistant/40/2>the</a> <a href=https://forum.airgradient.com/t/sharing-my-experiences/152>internet</a> leads me to <a href=https://www.home-assistant.io/>Home Assistant (HA)</a> + <a href=https://esphome.io/>ESPHome</a> setup.</p><p>My options for hosting HA are:</p><ol><li>reuse Raspberry Pi 2 model B that already runs <a href=../my-first-pi-hole.md>Pi-hole</a>,</li><li>use old 15" MacBook from 2015,</li><li>use cheapo 14" Lenovo laptop from 2015 (it runs Arch btw),</li><li>reuse cloud VM (small droplet in SG region that runs NixOS),</li><li>buy ready-to-use <a href=https://www.home-assistant.io/yellow/>Home Assistant server</a>,</li><li>buy new Raspberry Pi 4</li></ol><p>I went through the possible <a href=https://www.home-assistant.io/installation/>HA installation methods</a> to cross-check
which host should I use for HA.</p><p>Possible HA installation methods are:</p><ul><li>Supervised: this requires strict dependencies setup and maintaining them, no go.</li><li>OS: this requires wiping the host OS or running VM inside the host, which requires non-trivial overhead for CPU consumption etc. Keen to avoid this.</li><li>Core: oh it&rsquo;s Python, sorry but I do not want to manage Python installation, no go.</li><li>Container: this require a container environment and running a built HA image.</li></ul><p>Container installation is the most sane setup for me, so I&rsquo;m going with it.
(Later on I realized HA container cannot use HA add-ons.
That means I cannot use <a href=https://esphome.io/guides/getting_started_hassio>ESPHome HA add-ons</a> to make things easier.
But that is fine, I could live without the add-ons.)</p><p>Going back to my hosting choices and by the process of elimination:</p><ul><li>Raspberry Pi 2 probably won&rsquo;t be strong enough, HA recommends Pi 3 or 4. So, no go.
(I saw <a href=https://community.home-assistant.io/t/what-is-needed-to-set-up-home-assistant-on-a-raspberry-pi-2-model-b/373544/15>some people</a> tried running HA on Pi 2B, it&rsquo;s kinda hit and miss.)</li><li>Cloud VM probably will work, but requires internet connection. Keeping this as last resort.</li><li>HA Yellow, I checked the price from the <a href=https://www.seeedstudio.com/Home-Assistant-Yellow-Kit-with-selectable-CM4-p-5680.html>Chinese supplier</a>, it&rsquo;s going to cost 179 USD or more, not including shipping and tax.
No thanks, that&rsquo;s too expensive for me.</li><li>New Raspberry Pi 4: The official supplier is either gone or out of stock here.
And there&rsquo;s only scalper with crazy price tag in local marketplace. No thanks.</li><li>Old laptops, these are my best bets for now.</li></ul><p>At the end, I picked the MacBook over Lenovo since it has better CPU.
It runs macOS 12 and the UI is a bit laggy, but it should be good enough
since I&rsquo;m only accessing it via SSH anyway.</p><h3 id=for-flashing-the-microcontroller>For flashing the microcontroller<a hidden class=anchor aria-hidden=true href=#for-flashing-the-microcontroller>#</a></h3><p>I need to reflash the D1 mini to make it send data to my server.
I have no idea how to do it though, reading ESPHome website feels overwhelming at first.
After furiously reading the docs, FAQ, and a mug of coffee, I think I get it.</p><p>With ESPHome, you:</p><ol><li>write declarative config (in YAML) for the micrcontroller firmware instead of writing the code directly.</li><li>use <a href=https://esphome.io/guides/getting_started_command_line>ESPHome CLI</a> to compile the YAML config into a runnable firmware and upload it to the microcontroller.</li></ol><p>I will be using Docker on macOS to run ESPHome and according to <a href="https://esphome.io/guides/getting_started_command_line.html#:~:text=You%20will%20not%20be%20able%20to%20flash%20ESP%20devices%20through%20USB%20on%20Mac%2C%20all%20other%20features%20will%20work.%20Flashing%20with%20web%20dashboard%20is%20still%20possible.">this</a>,
I won&rsquo;t be able to flash via USB cable.
So I will need to use <a href=https://web.esphome.io/>ESPHome&rsquo;s web flasher</a>.</p><h2 id=what-work-are-done-to-start-seeing-numbers-in-dashboard>What work are done to start seeing numbers in dashboard?<a hidden class=anchor aria-hidden=true href=#what-work-are-done-to-start-seeing-numbers-in-dashboard>#</a></h2><h3 id=assembling-the-airgradient-kit>Assembling the AirGradient kit<a hidden class=anchor aria-hidden=true href=#assembling-the-airgradient-kit>#</a></h3><p>AirGradient has the full assembly instruction in <a href=https://www.airgradient.com/open-airgradient/instructions/>their website</a>.
Mine is pretty straightforward since I bought the pre-soldered kit which involves
sticking sensor to the correct places.</p><figure><img loading=lazy src=/p/airgradient/airgradient-unassembled.jpg alt="Pre-soldered AirGradient kit that comes with the display and PM sensor already attached."><figcaption><p>Pre-soldered AirGradient kit that comes with the display and PM sensor already attached.</p></figcaption></figure><script defer src=https://cdn.jsdelivr.net/npm/lightense-images@1.0.17/dist/lightense.min.js integrity="sha256-0L7PA+rlAMaq+Gkzls+i1cUvY9i7D+XF/Yl3BhYKABo=" crossorigin=anonymous></script><script defer type=text/javascript>window.addEventListener("load",function(){Lightense('img:not(.no-lightense, [aria-label="logo"])',{background:"rgb(155, 156, 157 / 60%)"})},!1)</script><figure><img loading=lazy src=/p/airgradient/airgradient-assembled.jpg alt="Fully assembled kit, with everything sticked in."><figcaption><p>Fully assembled kit, with everything sticked in.</p></figcaption></figure><h3 id=sanity-checking-the-kit>Sanity checking the kit<a hidden class=anchor aria-hidden=true href=#sanity-checking-the-kit>#</a></h3><p>Power on the kit by connecting to power supply.
Make sure everything is looks good, sensors and display are working.
Better do this before screwing the enclosure tightly.</p><p>I don&rsquo;t have other sensor for baseline of the installed sensors though.
So I can&rsquo;t sense check the sensor values.</p><h3 id=flashing-the-microcontroller>Flashing the microcontroller<a hidden class=anchor aria-hidden=true href=#flashing-the-microcontroller>#</a></h3><ol><li>Connect the microcontroller directly to a computer with USB cable.
<strong>Connecting the cable to the PCB will not work!</strong></li><li>Open up <a href=https://web.esphome.io/>web flasher</a>.</li><li>In the flasher, press connect and pick the microcontroller and connect.
On mine, it says &ldquo;USB Serial (cu.usbserial-1120)&rdquo;.
Yours might be different.</li><li>Press &ldquo;PREPARE FOR FIRST USE&rdquo;.
Read the explanation first and install after understanding it.</li><li>Wait for it to finish installing.</li><li>After done installing, continue setting up Wi-Fi for the device in the flasher.
This will allow us to flash over the network.</li><li>If everything works fine, you should be able to access the web server hosted
in the microcontoller by accessing the device IP directly.</li></ol><p>At this point we can start writing ESPHome config be flashed over the network.
I would expect myself taking months to finish writing the config.
Thankfully a nice person has shared their config in the internet, like <a href=https://github.com/ajfriesen/ESPHome-AirGradient>this one</a>.
I end up using this config from <a href=https://github.com/ajfriesen/ESPHome-AirGradient/pull/17>@ex-nerd&rsquo;s PR</a>.
Specifically <a href=https://github.com/ajfriesen/ESPHome-AirGradient/blob/e21604d3455b6fc5429789a8046ff045d4c2a8f9/air-gradient-pro-diy.yaml>this file</a> that&rsquo;s intended for AirGradient Pro version 4.2.</p><p>Steps I did for compiling the firmware:</p><ol><li>Copy the AirGradient config YAML and <code>secrets.yaml</code>,
save them in a new directory somewhere in the computer.</li><li>Modify the config as needed, the instruction comments in there is pretty self explanatory.
While editing the YAML, the editor IDE might complain about &ldquo;Unresolved tag: !secret&rdquo;.
It&rsquo;s fine to ignore those warnings.
Those are <a href=https://www.home-assistant.io/docs/configuration/splitting_configuration/>HA config specifics</a> that is <a href="https://esphome.io/guides/faq#:~:text=ESPHome%20supports%20(most%20of)%20Home%20Assistant%E2%80%99s%20YAML%20configuration%20directives%20like%20!include%20and%20!secret.%20So%20you%20can%20store%20all%20your%20secret%20WiFi%20passwords%20and%20so%20on%20in%20a%20file%20called%20secrets.yaml%20within%20the%20directory%20where%20the%20configuration%20file%20is.">also supported by ESPHome</a>.</li><li>Fill in the variables in the <code>secrets.yaml</code>.
For the <code>home_assistant_encryption_key</code>, it needs to be base64 string.
The <a href=https://esphome.io/components/api.html>docs page</a> from ESPHome has a generator for it.<blockquote><p>‚úÖ Make sure to backup <code>secrets.yaml</code>, otherwise you will need to reflash
if you lose access.</p></blockquote></li><li>Run <a href=https://esphome.io/guides/getting_started_command_line>ESPHome CLI</a> to compile and upload the firmware to the microcontroller.
I&rsquo;m using Docker to run it, so mine looks like this:
<code>docker run --rm -v "${PWD}":/config -it ghcr.io/esphome/esphome run air-gradient-pro-diy.yaml</code>.</li></ol><p>In my case, the upload step failed because <code>esphome</code> unable to find my device.
Error log:</p><pre tabindex=0><code class=language-log data-lang=log>...
Linking .pioenvs/airgradient-pro-0/firmware.elf
RAM:   [=====     ]  49.3% (used 40392 bytes from 81920 bytes)
Flash: [======    ]  64.7% (used 675549 bytes from 1044464 bytes)
Building .pioenvs/airgradient-pro-0/firmware.bin
esp8266_copy_factory_bin([&#34;.pioenvs/airgradient-pro-0/firmware.bin&#34;], [&#34;.pioenvs/airgradient-pro-0/firmware.elf&#34;])
================================================================================= [SUCCESS] Took 536.00 seconds =================================================================================
INFO Successfully compiled program.
INFO Resolving IP address of airgradient-pro-0.local
ERROR Error resolving IP address of airgradient-pro-0.local. Is it connected to WiFi?
ERROR (If this error persists, please set a static IP address: https://esphome.io/components/wifi.html#manual-ips)
ERROR Error resolving IP address: Error resolving address with mDNS: Did not respond. Maybe the device is offline., [Errno -3] Temporary failure in name resolution
</code></pre><p>So I had to <a href="https://esphome.io/components/wifi.html#:~:text=manual_ip%20(Optional)%3A%20Manually%20configure%20the%20static%20IP%20of%20the%20node.">setup static IP</a> in the config
and rerun the docker command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>wifi</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>manual_ip</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Set this to the IP of the ESP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;192.168.100.152&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Set this to the IP address of the router. Often ends with .1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gateway</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;192.168.100.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The subnet of the network. 255.255.255.0 works for most home networks.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>subnet</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;255.255.255.0&#34;</span><span class=w>
</span></span></span></code></pre></div><p>After rerunning the compile command and a successful uploads,
the CLI will start streaming the logs from the device nonstop.
Success logs:</p><pre tabindex=0><code>...
INFO Successfully compiled program.
INFO Connecting to 192.168.100.152
INFO Uploading .esphome/build/airgradient-pro-1/.pioenvs/airgradient-pro-1/firmware.bin (680288 bytes)
INFO Compressed to 475364 bytes
Uploading: [============================================================] 100% Done...

INFO Waiting for result...
INFO OTA successful
INFO Successfully uploaded program.
INFO Starting log output from 192.168.100.152 using esphome API
INFO Successfully connected to 192.168.100.152
[19:48:18][I][app:102]: ESPHome version 2023.8.2 compiled on Sep  8 2023, 19:46:22
...
</code></pre><p>Can terminate the CLI safely after upload succeeds and it start streaming the logs.</p><p>The display should also lit up and start showing the pages specified in the config YAML.
Some of sensor numbers might show up as <code>N/A</code> for a while.
I haven&rsquo;t debugged this, but after leaving it powered on for few mins,
<code>N/A</code> got replaced with numbers.
So the sensors might be just starting and simply haven&rsquo;t picked up and sent any data yet.</p><p>Now we have the sensors ready to send data,
it&rsquo;s time to setup the receiving part!</p><h3 id=setting-up-home-assistant-container>Setting up Home Assistant container<a hidden class=anchor aria-hidden=true href=#setting-up-home-assistant-container>#</a></h3><p><a href=https://www.home-assistant.io/installation/macos>MacOS HA installation docs</a> actually does not have container installation.
Luckily prior to this, I already found <a href=https://blog.illixion.com/2023/04/colima-home-assistant/>this post from Ixion</a> about setting up Home Assistant on macOS.
I accidentally found that post when trying to find a way to run HA VM image using <a href=https://github.com/lima-vm/lima>Lima</a>,
with the <code>lima</code> keyword accidentally matching on the <a href=https://github.com/abiosoft/colima><code>colima</code></a> used in the post.</p><p>What I did to set up HA is exactly as described in Ixion&rsquo;s post, summarized as:</p><blockquote><ol><li>Install Colima and Docker on macOS (using brew)</li><li>Start Colima</li><li>Configure Colima to use the host network</li><li>Install Home Assistant on Docker</li><li>Set up Home Assistant</li></ol><p><a href=https://blog.illixion.com/2023/04/colima-home-assistant/>https://blog.illixion.com/2023/04/colima-home-assistant/</a></p></blockquote><p>With some exceptions:</p><ul><li>When configuring Lima to use <code>socket_vmnet</code>, my path for <code>socket_vmnet</code> is different.
I had to a bit of manual <code>cd</code> and <code>ls</code> ritual, and found mine on <code>/usr/local/opt/socket_vmnet/bin/socket_vmnet</code>
instead of <code>/opt/homebrew/bin/socket_vmnet</code>.
I just learned brew has subcommand for finding the path, <code>brew info &lt;formula></code>,
e.g. <code>brew info socket_vmnet</code> and it will spit out the installation path.</li><li>When opening the network settings in HA, mine is blank.
Turns out I need to turn on &ldquo;Advanced Mode&rdquo; in my HA profile.
After that, I can open the network settings and pick <code>lima0</code> network adapter.
Before realizing that, I thought the network settings is not accessible
remotely. I tried accessing from localhost by port forwarding
the dashboard, it didn&rsquo;t help at all.</li></ul><h3 id=connecting-airgradient-with-home-assistant>Connecting AirGradient with Home Assistant<a hidden class=anchor aria-hidden=true href=#connecting-airgradient-with-home-assistant>#</a></h3><p>According to this <a href=https://www.home-assistant.io/integrations/esphome/>HA docs</a>, HA should be able to automatically
discover a running ESPHome device in the same network.
I have not tried it.
Instead I tried manually adding the ESPHome device or in this case the AirGradient
to HA.</p><p>From the HA dashboard, do:</p><ol><li>Open &ldquo;Settings > Devices & Services&rdquo;,</li><li>In &ldquo;Integrations&rdquo; tab, press &ldquo;ADD INTEGRATION&rdquo; in bottom right,</li><li>Search and click &ldquo;ESPHome&rdquo; integration,</li><li>Put the AirGradient IP in the host field, keep the default <code>6053</code> port, and submit.</li><li>If HA can find and connect to AirGradient, it will ask for encryption key.
Paste in the <code>home_assistant_encryption_key</code> configured in <code>secrets.yaml</code>
that&rsquo;s used for flashing the AirGradient.</li></ol><p>That&rsquo;s all! I can see my AirGradient sensors in HA dashboard.</p><figure><img loading=lazy src=/p/airgradient/ha-dashboard.png alt="My HA dashboard after connecting one AirGradient kit."><figcaption><p>My HA dashboard after connecting one AirGradient kit.</p></figcaption></figure><h2 id=why-im-getting-cant-connect-to-esp-when-connecting-airgradient-to-ha>Why I&rsquo;m getting <code>Can't connect to ESP.</code> when connecting AirGradient to HA?<a hidden class=anchor aria-hidden=true href=#why-im-getting-cant-connect-to-esp-when-connecting-airgradient-to-ha>#</a></h2><p>Make sure AirGradient is discoverable from HA.</p><p>In my case, I was accessing HA dashboard via <a href=https://tailscale.com/kb/1081/magicdns/>Tailscale Magic DNS</a>.
So my dashboard URL looks like: <code>http://unicorn:8123</code>.
And when adding AirGradient, I keep getting <code>Can't connect to ESP.</code> error
even with the correct IP.
After using SSH tunnel to expose the dashboard as: <code>http://localhost:8123</code>,
adding AirGradient worked!</p><p>The tunnel command looked something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -L 8123:localhost:8123 -N -T darcien@unicorn
</span></span></code></pre></div><h2 id=my-ha-container-does-not-expose-any-address-in-colima-list>My HA container does not expose any address in <code>colima list</code>!<a hidden class=anchor aria-hidden=true href=#my-ha-container-does-not-expose-any-address-in-colima-list>#</a></h2><p>Try doing <code>colima restart</code>, and restart the HA container.
Also check the container log for more clue.</p><h2 id=restarting-ha-container-with-colima-restart-failed>Restarting HA container with <code>colima restart</code> failed!<a hidden class=anchor aria-hidden=true href=#restarting-ha-container-with-colima-restart-failed>#</a></h2><p>In my case, <code>colima</code> gives a nice hint:</p><pre tabindex=0><code class=language-log data-lang=log>‚ùØ colima restart
INFO[0000] stopping colima
INFO[0000] not running                                   context=vm
INFO[0000] done
INFO[0003] starting colima
INFO[0003] runtime: docker
INFO[0003] preparing network ...                         context=vm
INFO[0003] starting ...                                  context=vm
&gt; Using the existing instance &#34;colima&#34;
&gt; can&#39;t read &#34;/private/etc/sudoers.d/lima&#34;: failed to run [sudo --user daemon --group everyone --non-interactive true]: exit status 1 (Hint: run `limactl sudoers &gt;etc_sudoers.d_lima &amp;&amp; sudo install -o root etc_sudoers.d_lima &#34;/private/etc/sudoers.d/lima&#34;`))
FATA[0003] error starting vm: error at &#39;starting&#39;: exit status 1
</code></pre><p>It was a permission issue, and running the command specified in the hint fixed it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>limactl sudoers &gt;etc_sudoers.d_lima <span class=o>&amp;&amp;</span> sudo install -o root etc_sudoers.d_lima <span class=s2>&#34;/private/etc/sudoers.d/lima&#34;</span>
</span></span></code></pre></div><h2 id=how-much-does-it-cost-total>How much does it cost total?<a hidden class=anchor aria-hidden=true href=#how-much-does-it-cost-total>#</a></h2><table><thead><tr><th>Parts</th><th style=text-align:right>Price (IDR)</th></tr></thead><tbody><tr><td>AirGradient Pro DIY (pre-soldered) x 2</td><td style=text-align:right>4.544.100</td></tr><tr><td>AirGradient import tax</td><td style=text-align:right>294.400</td></tr><tr><td>Power supply 5V 3A x 2</td><td style=text-align:right>271.700</td></tr><tr><td>USB-C 3m cable</td><td style=text-align:right>93.500</td></tr><tr><td>3M plastic hook x2</td><td style=text-align:right>29.640</td></tr><tr><td>Old MacBook</td><td style=text-align:right>0</td></tr><tr><td>&mdash;</td><td style=text-align:right>&mdash;</td></tr><tr><td>Total</td><td style=text-align:right>5.233.340</td></tr></tbody></table><p>Using 1 USD = 14850 IDR conversion for AirGradient price calculation.</p><p>It&rsquo;s a bit expensive for your average Indonesian, but still pretty good price
when compared to commercial air monitor sold here, like this <a href=https://aria.tech/airtest>AirTest from Aria Indonesia</a>.
The AirTest only have PM2.5 sensor, no idea what specific sensor is installed in it.
It is sold at 1.990.000 IDR and have 30 days pre-order<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>,
now that&rsquo;s expensive for a single sensor with closed design.</p><h2 id=how-much-electricity-does-this-setup-use>How much electricity does this setup use?<a hidden class=anchor aria-hidden=true href=#how-much-electricity-does-this-setup-use>#</a></h2><figure><img loading=lazy src=/p/airgradient/macbook-power-usage_hu_b5b32ceedd441a50.jpg alt="A power meter showing 0.945 KWh after 6 days 15 hours 10 minutes for the server (from empty battery)."><figcaption><p>A power meter showing 0.945 KWh after 6 days 15 hours 10 minutes for the server (from empty battery).</p></figcaption></figure><p>0.945 KWh = 6 days 15 hours 10 minutes</p><p>0.945 KWh = 9550 minutes</p><p>0.006 KWh = 60 minutes</p><p>That&rsquo;s 0.006 KWh per hour, or 4.32 KWh per month.
So I&rsquo;m paying around 6.241 IDR per month using 1.444,7 IDR per KWh rate.</p><p>I&rsquo;m excluding the electricity usage from the sensors because they&rsquo;re too low.
Leaving the metered sensors a week gave me 0 KWh on the power meter.</p><h2 id=what-is-the-gfonts-in-the-esphome-config>What is the <code>gfonts://</code> in the ESPHome config?<a hidden class=anchor aria-hidden=true href=#what-is-the-gfonts-in-the-esphome-config>#</a></h2><p>It&rsquo;s <a href="https://esphome.io/components/display/index.html#:~:text=You%20can%20use%20the%20gfonts%3A//%20short%20form%20to%20use%20Google%20Fonts">a special ESPHome syntax</a> for using Google Fonts in the display.</p><h2 id=how-long-until-the-sensors-needs-to-be-replaced>How long until the sensors needs to be replaced?<a hidden class=anchor aria-hidden=true href=#how-long-until-the-sensors-needs-to-be-replaced>#</a></h2><p>I&rsquo;m not too sure yet.
I&rsquo;m seeing some discussion about this in AirGradient forum,
and AirGradient said they still have PMS5003 sensor working even after 4 years<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.
I sure hope Jakarta&rsquo;s air is not polluted enough to the point I need to
replace PM sensors often.
At that point, sensor life expectancy is the least of my worries.</p><h2 id=back-up-plans-for-ha-container>Back up plans for HA container?<a hidden class=anchor aria-hidden=true href=#back-up-plans-for-ha-container>#</a></h2><p>As I just finished with setting up, I have no concrete plans yet.
I looked a bit into the forum and found <a href=https://community.home-assistant.io/t/what-backup-strategy-when-running-home-assistant-in-docker/262539/7>this thread</a>
which has various approaches.
Standing up an automatic backup most likely won&rsquo;t be a 5 minutes job,
so I will need to revisit this later.</p><h2 id=how-accurate-is-the-pm-sensors-used-ie-pms5003>How accurate is the PM sensors used? i.e. PMS5003<a hidden class=anchor aria-hidden=true href=#how-accurate-is-the-pm-sensors-used-ie-pms5003>#</a></h2><p>I learnt from <a href="https://news.ycombinator.com/item?id=36501314">this post</a> that PMS5003 is using approximation for
PM2.5 and PM10, and is only accurate for PM1.
Well fortunately, <a href=https://blog.quant-aq.com/can-your-plantower-pms5003-based-air-quality-sensor-measure-pm10/>the in-depth explanation</a> proves PMS5003
is good enough for urban environment that doesn&rsquo;t change too much like my
bedroom and livingroom!</p><h2 id=various-photos>Various photos<a hidden class=anchor aria-hidden=true href=#various-photos>#</a></h2><h3 id=airgradient-packaging-and-boxes>AirGradient packaging and boxes<a hidden class=anchor aria-hidden=true href=#airgradient-packaging-and-boxes>#</a></h3><figure><img loading=lazy src=/p/airgradient/airgradient-package_hu_8caef55e8341b8a7.jpg alt="AirGradient package that looks manually packaged by hand and sent from Thailand."><figcaption><p>AirGradient package that looks manually packaged by hand and sent from Thailand.</p></figcaption></figure><figure><img loading=lazy src=/p/airgradient/airgradient-boxes_hu_e75361875508031c.jpg alt="Two boxes of AirGradient Pro DIY kit."><figcaption><p>Two boxes of AirGradient Pro DIY kit.</p></figcaption></figure><figure><img loading=lazy src=/p/airgradient/airgradient-box-open_hu_fed09f719f886afd.jpg alt="First look after opening the kit."><figcaption><p>First look after opening the kit.</p></figcaption></figure><h3 id=airgradient>AirGradient<a hidden class=anchor aria-hidden=true href=#airgradient>#</a></h3><figure><img loading=lazy src=/p/airgradient/airgradient-on-wall.jpg alt="AirGradient in action.
Yes, the CO2 is high, my room has bad air circulation.
Yes, the electric socket below has slight openings and is hazardous,
I need to fix it eventually."><figcaption><p>AirGradient in action.
Yes, the CO2 is high, my room has bad air circulation.
Yes, the electric socket below has slight openings and is hazardous,
I need to fix it eventually.</p></figcaption></figure><figure><img loading=lazy src=/p/airgradient/airgradient-back-side_hu_f00aab0843ede6e2.jpg alt="Back side view of AirGradient. To avoid punching a hole in the wall, I&rsquo;m using knitting thread to hang the unit."><figcaption><p>Back side view of AirGradient. To avoid punching a hole in the wall, I&rsquo;m using knitting thread to hang the unit.</p></figcaption></figure><h3 id=others>Others<a hidden class=anchor aria-hidden=true href=#others>#</a></h3><figure><img loading=lazy src=/p/airgradient/power-supply_hu_bcfee249145a130.jpg alt="The 5V 3A power supply I&rsquo;m using for powering AirGradient."><figcaption><p>The 5V 3A power supply I&rsquo;m using for powering AirGradient.</p></figcaption></figure><h2 id=changelog>Changelog<a hidden class=anchor aria-hidden=true href=#changelog>#</a></h2><ul><li>2023-10-13: add electricity usage</li><li>2023-09-08: initial version</li></ul><hr><p>Post 22 of <a href=https://100daystooffload.com/>#100DaysToOffload</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://edition.cnn.com/2023/08/16/asia/indonesia-pollution-jokowi-cough-intl-hnk/index.html>https://edition.cnn.com/2023/08/16/asia/indonesia-pollution-jokowi-cough-intl-hnk/index.html</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://web.archive.org/web/20230909181316/https://www.tokopedia.com/ariatechnologies/indoor-air-quality-pm2-5-monitor-aria-airtest>https://web.archive.org/web/20230909181316/https://www.tokopedia.com/ariatechnologies/indoor-air-quality-pm2-5-monitor-aria-airtest</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href="https://forum.airgradient.com/t/extending-the-life-span-of-the-pms5003-sensor/114/23#:~:text=We%20have%20many%20PMS5003%20still%20working%20after%20four%20years%20without%20issues.%20If%20you%20are%20not%20living%20in%20a%20very%20polluted%20environment%20they%20will%20probably%20last%20longer%20than%203%20years">https://forum.airgradient.com/t/extending-the-life-span-of-the-pms5003-sensor/114/23#:~:text=We%20have%20many%20PMS5003%20still%20working%20after%20four%20years%20without%20issues.%20If%20you%20are%20not%20living%20in%20a%20very%20polluted%20environment%20they%20will%20probably%20last%20longer%20than%203%20years</a>.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://darcien.dev/tags/homesetup/>Homesetup</a></li><li><a href=https://darcien.dev/tags/100daystooffload/>100DaysToOffload</a></li></ul><nav class=paginav><a class=prev href=https://darcien.dev/p/codespace/><span class=title>¬´ Prev</span><br><span>Who used my codespace?</span>
</a><a class=next href=https://darcien.dev/p/bought-goods-from-booth-again/><span class=title>Next ¬ª</span><br><span>Bought goods from BOOTH.pm (again) with EMS</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 A blog by Yosua Ian Sebastian</span><br><span>Blog logo is a recolored <a target=_blank referrerpolicy=no-referrer rel=noopener href=https://twemoji.twitter.com/>Spouting Whale Twemoji</a> by Twitter, Inc
and other contributors and is licensed under <a target=_blank referrerpolicy=no-referrer rel=noopener href=https://creativecommons.org/licenses/by/4.0/>CC-BY
4.0</a></span><div class=footer-blank>This space intentionally left blank.</div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>